<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syn7h_</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior: none; 
            background-color: #1a202c; 
            color: #e2e8f0; 
        }
        .keyboard-container { width: 100%; overflow-x: auto; padding-bottom: 10px; }
        .keyboard { 
            display: flex; 
            justify-content: flex-start; 
            align-items: flex-start; 
            padding: 20px; 
            background-color: #2d3748; 
            border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            position: relative; 
            min-width: min-content; 
            height: 210px; 
            -webkit-user-select: none; -ms-user-select: none; user-select: none; 
        }
        .key { 
            border: 1px solid #4a5568; 
            border-radius: 5px; 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            font-size: 10px; 
            padding-bottom: 5px; 
            transition: background-color 0.1s ease; 
            box-sizing: border-box; 
            position: absolute; 
            top: 0; 
        }
        .white-key { 
            background-color: #f7fafc; 
            color: #2d3748; 
            width: 38px; 
            height: 170px; 
            z-index: 1; 
        }
        .white-key:active, .white-key.active { background-color: #a0aec0; }
        .black-key { 
            background-color: #2d3748; 
            color: #cbd5e0; 
            width: 26px; 
            height: 100px; 
            z-index: 2; 
            border: 1px solid #1a202c;
            margin-left: -13px; /* Pulls it back by half its width to center it */
        }
        .black-key:active, .black-key.active { background-color: #4a5568; }
        
        .controls-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; width: 100%; max-width: 1400px; }
        .control-group { display: flex; flex-direction: column; align-items: stretch; padding: 12px; background-color: #2d3748; border: 1px solid #4a5568; border-radius: 8px; }
        .control-group label, .control-group .group-title { margin-bottom: 8px; font-size: 0.875rem; color: #a0aec0; font-weight: 600; text-align: center; text-transform: uppercase; letter-spacing: 0.05em;}
        .control-group select, .control-group button, .control-group input[type="range"], .control-group input[type="checkbox"], .control-group input[type="file"], .control-group input[type="text"] { padding: 8px 6px; border-radius: 6px; border: 1px solid #4a5568; background-color: #1a202c; font-size: 0.875rem; cursor: pointer; color: #e2e8f0; width: 100%; box-sizing: border-box; margin-bottom: 4px; }
        .control-group input[type="file"] { padding: 4px; }
        .control-group input[type="text"] { cursor: text; }
        .control-group input[type="checkbox"] { width: auto; align-self:center; height: 20px; padding:0; margin-bottom: 8px; accent-color: #f56565;}
        .control-group button { background-color: #f56565; color: #1a202c; font-weight: bold; border: none;}
        .control-group button:hover { background-color: #dd5858; }
        .control-group input[type="range"] { padding: 0; height: auto; accent-color: #f56565; }
        .control-group .button-group { display: flex; justify-content: space-around; }
        .control-group .button-group button { width: auto; padding: 6px 10px; }
        .value-display { font-size: 0.75rem; color: #718096; margin-top: 0px; text-align: center; height: 1.2em; }
        .hidden { display: none !important; }

        .message-box-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .message-box-overlay.visible { opacity: 1; visibility: visible; }
        .message-box-content { background-color: #2d3748; padding: 25px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; color: #e2e8f0; border: 1px solid #4a5568;}
        .message-box-content button { margin-top: 15px; padding: 10px 20px; border-radius: 6px; background-color: #f56565; color: #1a202c; font-weight: bold; border: none; cursor: pointer; transition: background-color 0.2s ease;}
        .message-box-content button:hover { background-color: #dd5858; }
        
        #midi-status { margin-top: 10px; padding: 8px; background-color: #2d3748; border-radius: 6px; text-align:center; font-size: 0.9em; color: #a0aec0; border: 1px solid #4a5568;}
        .instructions { font-size: 0.8em; color: #718096; margin-top:10px; text-align:center; }
        
        .title-container { display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; }
        .logo { width: 60px; height: 60px; margin-right: 15px; stroke: #f56565; stroke-width: 2; fill: none; }
        .main-title { font-family: 'Orbitron', sans-serif; font-size: 2.8rem; color: #e2e8f0; text-shadow: 0 0 5px #f56565, 0 0 10px #f56565, 0 0 15px #f5656533; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4 select-none">

    <div class="w-full max-w-7xl mx-auto flex flex-col items-center">
        <div class="title-container">
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                 <path d="M20 80 L35 80 L40 70 L50 90 L60 50 L65 75 L80 20" stroke-linecap="round" stroke-linejoin="round"/>
                 <path d="M20 20 L80 20 L80 80 L20 80 Z" stroke-width="1.5" stroke-dasharray="5, 5" />
                 <path d="M5 5 L95 5 L95 95 L5 95 Z" stroke-width="0.5" stroke="#4a5568"/>
            </svg>
            <h1 class="main-title">Syn7h_</h1>
        </div>

        <div class="controls-container mb-8">
            <!-- Main GROUP -->
            <div class="control-group">
                <span class="group-title">Main</span>
                <label for="preset-select" class="text-sm">Preset</label>
                <select id="preset-select" class="mb-2"></select>
                <div class="flex items-center mb-2">
                    <input type="text" id="preset-name-input" placeholder="New Preset Name..." class="flex-grow">
                    <button id="save-preset-button" class="ml-2 w-auto px-3">Save</button>
                </div>
                 <label for="volume">Master Volume</label><input type="range" id="volume" min="-40" max="0" value="0" step="1"><span id="volume-display" class="value-display">0 dB</span> 
                 <label for="midi-input-select" class="text-sm">MIDI Input</label>
                <select id="midi-input-select" class="mb-2"></select>
                 <label for="midi-channel-select" class="text-sm">MIDI Channel</label>
                <select id="midi-channel-select" class="mb-2"></select>
                <label for="osc-type">Oscillator Type</label>
                <select id="osc-type">
                    <option value="sine">Sine</option><option value="square">Square</option><option value="triangle">Triangle</option><option value="sawtooth">Sawtooth</option>
                    <option value="pulse">Pulse</option><option value="pwm">PWM</option><option value="fmsine">FM Sine</option><option value="amsine">AM Sine</option>
                    <option value="supersaw">Supersaw</option><option value="noise">Noise</option>
                    <option value="resonantbody">Resonant Body</option><option value="formantvoice">Formant Voice</option>
                    <option value="granular">Granular (Monophonic)</option> 
                </select>
                 <div class="osc-specific-controls">
                    <label for="osc-phase">Phase</label><input type="range" id="osc-phase" min="0" max="360" value="0" step="1"><span id="osc-phase-display" class="value-display">0 &deg;</span>
                </div>
                <div id="pulse-controls" class="hidden osc-specific-controls">
                    <label for="pulse-width">Pulse Width</label><input type="range" id="pulse-width" min="0.01" max="0.99" value="0.5" step="0.01"><span id="pulse-width-display" class="value-display">0.50</span>
                </div>
                <div id="pwm-controls" class="hidden osc-specific-controls">
                    <label for="pwm-speed">PWM Speed</label><input type="range" id="pwm-speed" min="0.1" max="20" value="5" step="0.1"><span id="pwm-speed-display" class="value-display">5 Hz</span>
                </div>
                <div id="fm-controls" class="hidden osc-specific-controls"> 
                    <label for="fm-harmonicity">FM Harmonicity</label><input type="range" id="fm-harmonicity" min="0.1" max="10" value="1.5" step="0.1"><span id="fm-harmonicity-display" class="value-display">1.5</span>
                    <label for="fm-mod-index">FM Mod Index</label><input type="range" id="fm-mod-index" min="1" max="50" value="10" step="1"><span id="fm-mod-index-display" class="value-display">10</span>
                </div>
                <div id="supersaw-controls" class="hidden osc-specific-controls">
                    <label for="supersaw-count">Saw Count</label><input type="range" id="supersaw-count" min="2" max="10" value="3" step="1"><span id="supersaw-count-display" class="value-display">3</span>
                    <label for="supersaw-spread">Spread (cents)</label><input type="range" id="supersaw-spread" min="0" max="100" value="25" step="1"><span id="supersaw-spread-display" class="value-display">25 cents</span>
                </div>
                <div id="noise-controls" class="hidden osc-specific-controls">
                     <label for="noise-type">Noise Type</label>
                     <select id="noise-type"><option value="white">White</option><option value="pink">Pink</option><option value="brown">Brown</option></select>
                </div>
                 <div id="resonantbody-controls" class="hidden osc-specific-controls">
                    <label for="resonantbody-harmonicity">FM Harm (Resonant)</label><input type="range" id="resonantbody-harmonicity" min="0.1" max="20" value="2.7" step="0.1"><span id="resonantbody-harmonicity-display" class="value-display">2.7</span>
                    <label for="resonantbody-mod-index">FM Index (Resonant)</label><input type="range" id="resonantbody-mod-index" min="1" max="100" value="20" step="1"><span id="resonantbody-mod-index-display" class="value-display">20</span>
                </div>
                <div id="formantvoice-controls" class="hidden osc-specific-controls">
                    <label for="formantvoice-harmonicity">FM Harm (Formant)</label><input type="range" id="formantvoice-harmonicity" min="0.1" max="5" value="1.2" step="0.1"><span id="formantvoice-harmonicity-display" class="value-display">1.2</span>
                    <label for="formantvoice-mod-index">FM Index (Formant)</label><input type="range" id="formantvoice-mod-index" min="1" max="30" value="5" step="1"><span id="formantvoice-mod-index-display" class="value-display">5</span>
                </div>
                <div id="granular-controls" class="hidden osc-specific-controls">
                    <label for="granular-file-input">Load WAV File</label>
                    <input type="file" id="granular-file-input" accept=".wav" class="text-xs">
                    <div class="flex items-center justify-around my-1"> 
                        <label for="granular-loop" class="text-sm mr-1">Loop</label><input type="checkbox" id="granular-loop" class="mr-2">
                        <label for="granular-reverse" class="text-sm mr-1">Reverse Grains</label><input type="checkbox" id="granular-reverse">
                    </div>
                    <label for="granular-loop-start">Loop Start</label><input type="range" id="granular-loop-start" min="0" max="1" value="0" step="0.01"><span id="granular-loop-start-display" class="value-display">0.00</span>
                    <label for="granular-loop-end">Loop End</label><input type="range" id="granular-loop-end" min="0" max="1" value="1" step="0.01"><span id="granular-loop-end-display" class="value-display">1.00</span>
                    <label for="granular-grain-size">Grain Size</label><input type="range" id="granular-grain-size" min="0.01" max="0.5" value="0.1" step="0.005"><span id="granular-grain-size-display" class="value-display">0.1 s</span>
                    <label for="granular-overlap">Overlap</label><input type="range" id="granular-overlap" min="-0.1" max="0.4" value="0.05" step="0.005"><span id="granular-overlap-display" class="value-display">0.05 s</span>
                    <label for="granular-detune">Detune (Spray)</label><input type="range" id="granular-detune" min="0" max="1200" value="0" step="10"><span id="granular-detune-display" class="value-display">0 cents</span>
                    <label for="granular-playback-rate">Playback Rate</label><input type="range" id="granular-playback-rate" min="0.1" max="4" value="1" step="0.05"><span id="granular-playback-rate-display" class="value-display">1.0x</span>
                    <p class="text-xs text-center mt-1 text-gray-400">Amp Env & Filter Env do not apply to Granular mode.</p>
                </div>
                <label for="octave-display-label">Starting Octave: <span id="octave-display">3</span></label>
                <div class="button-group mt-1">
                    <button id="octave-down-btn">-</button> 
                    <button id="octave-up-btn" class="ml-2">+</button>
                </div>
            </div>
            <!-- SEQUENCER GROUP -->
            <div class="control-group">
                <span class="group-title">Sequencer</span>
                <div class="flex items-center justify-center my-1">
                    <label for="sequencer-enable" class="text-sm mr-2">Enable</label><input type="checkbox" id="sequencer-enable">
                    <button id="sequencer-regen" class="ml-4">Regen</button>
                </div>
                <label for="sequencer-direction">Direction</label>
                <select id="sequencer-direction">
                    <option value="up">Up</option>
                    <option value="down">Down</option>
                    <option value="upDown">Up-Down</option>
                    <option value="random">Random</option>
                </select>
                <label for="sequencer-swing">Swing</label><input type="range" id="sequencer-swing" min="0" max="1" value="0" step="0.01"><span id="sequencer-swing-display" class="value-display">0.00</span>
                <label for="sequencer-rate">Clock Rate (Hz)</label><input type="range" id="sequencer-rate" min="0.1" max="20" value="2" step="0.1"><span id="sequencer-rate-display" class="value-display">2.0 Hz</span>
                <label for="sequencer-gate-prob">Gate Probability (%)</label><input type="range" id="sequencer-gate-prob" min="0" max="100" value="50" step="1"><span id="sequencer-gate-prob-display" class="value-display">50 %</span>
                <label for="sequencer-note-duration">Note Duration (s)</label><input type="range" id="sequencer-note-duration" min="0.05" max="2" value="0.1" step="0.01"><span id="sequencer-note-duration-display" class="value-display">0.10 s</span>
                <label for="sequencer-pitch-spread">Pitch Spread (Semi)</label><input type="range" id="sequencer-pitch-spread" min="0" max="24" value="7" step="1"><span id="sequencer-pitch-spread-display" class="value-display">7 semi</span>
                <label for="sequencer-scale">Scale</label>
                <select id="sequencer-scale">
                    <option value="chromatic">Chromatic</option>
                    <option value="major">Major</option>
                    <option value="minor">Natural Minor</option>
                    <option value="pentatonicMajor">Pentatonic Major</option>
                    <option value="pentatonicMinor">Pentatonic Minor</option>
                </select>
            </div>

            <!-- AMPLITUDE ENVELOPE GROUP -->
            <div class="control-group">
                <span class="group-title">Amplitude Envelope</span>
                <label for="amp-env-attack">Attack</label><input type="range" id="amp-env-attack" min="0.005" max="2" value="0.01" step="0.001"><span id="amp-env-attack-display" class="value-display">0.01 s</span>
                <label for="amp-env-decay">Decay</label><input type="range" id="amp-env-decay" min="0.01" max="2" value="0.1" step="0.01"><span id="amp-env-decay-display" class="value-display">0.1 s</span>
                <label for="amp-env-sustain">Sustain</label><input type="range" id="amp-env-sustain" min="0" max="1" value="0.4" step="0.01"><span id="amp-env-sustain-display" class="value-display">0.4</span>
                <label for="amp-env-release">Release</label><input type="range" id="amp-env-release" min="0.01" max="5" value="0.8" step="0.01"><span id="amp-env-release-display" class="value-display">0.8 s</span>
            </div>
            <!-- FILTER & FILTER ENVELOPE GROUP -->
            <div class="control-group">
                <span class="group-title">Filter & Envelope</span>
                <label for="filter-type">Filter Type</label> <select id="filter-type"> <option value="none">None (Bypass Filter)</option><option value="moog">Lowpass (-24dB 'Moog')</option><option value="ms20lp">Lowpass (-12dB 'MS-20')</option><option value="303lp">303 Lowpass (-24dB)</option><option value="ms20hp">Highpass (-12dB 'MS-20')</option>  <option value="bandpass12">Bandpass (-12dB)</option><option value="bandpass24">Bandpass (-24dB)</option><option value="notch12">Notch (-12dB)</option><option value="notch24">Notch (-24dB)</option><option value="allpass">Allpass</option> </select> 
                <label for="filter-env-curve">Env Curve</label> <select id="filter-env-curve"><option value="linear">Linear</option><option value="exponential">Exponential</option></select>
                <label for="filter-cutoff">Cutoff (Base Freq)</label><input type="range" id="filter-cutoff" min="20" max="20000" value="15000" step="1"><span id="filter-cutoff-display" class="value-display">15000 Hz</span> 
                <label for="filter-resonance">Resonance (Q)</label><input type="range" id="filter-resonance" min="0.1" max="30" value="1" step="0.1"><span id="filter-resonance-display" class="value-display">1.0 Q</span> 
                <label for="filter-env-attack">Env Attack</label><input type="range" id="filter-env-attack" min="0.005" max="2" value="0.05" step="0.001"><span id="filter-env-attack-display" class="value-display">0.05 s</span>
                <label for="filter-env-decay">Env Decay</label><input type="range" id="filter-env-decay" min="0.01" max="2" value="0.2" step="0.01"><span id="filter-env-decay-display" class="value-display">0.2 s</span>
                <label for="filter-env-sustain">Env Sustain</label><input type="range" id="filter-env-sustain" min="0" max="1" value="0.5" step="0.01"><span id="filter-env-sustain-display" class="value-display">0.5</span>
                <label for="filter-env-release">Env Release</label><input type="range" id="filter-env-release" min="0.01" max="5" value="1" step="0.01"><span id="filter-env-release-display" class="value-display">1.0 s</span>
                <label for="filter-env-amount">Env Amount (Octaves)</label><input type="range" id="filter-env-amount" min="-7" max="7" value="3" step="0.1"><span id="filter-env-amount-display" class="value-display">3 oct</span>
            </div>
            <!-- LFO 1 GROUP -->
            <div class="control-group"> <span class="group-title">LFO 1</span> <div class="flex items-center justify-center my-1"><label for="lfo1-enable" class="text-sm mr-2">Enable</label><input type="checkbox" id="lfo1-enable"><label for="lfo1-retrigger" class="text-sm ml-4 mr-1">Retrigger</label><input type="checkbox" id="lfo1-retrigger"></div> <label for="lfo1-wave">Waveform</label> <select id="lfo1-wave"> <option value="sine">Sine</option><option value="square">Square</option><option value="triangle">Triangle</option><option value="sawtooth">Sawtooth</option> <option value="pulse">Pulse</option><option value="pwm">PWM</option> </select> <div id="lfo1-pulse-width-controls" class="hidden"> <label for="lfo1-pulse-width">Pulse Width</label><input type="range" id="lfo1-pulse-width" min="0.01" max="0.99" value="0.5" step="0.01"><span id="lfo1-pulse-width-display" class="value-display">0.5</span> </div> <div id="lfo1-pwm-freq-controls" class="hidden"> <label for="lfo1-pwm-freq">PWM Freq</label><input type="range" id="lfo1-pwm-freq" min="0.1" max="20" value="2" step="0.1"><span id="lfo1-pwm-freq-display" class="value-display">2 Hz</span> </div> <label for="lfo1-rate">Rate</label><input type="range" id="lfo1-rate" min="0.1" max="30" value="2" step="0.1"><span id="lfo1-rate-display" class="value-display">2 Hz</span> <label for="lfo1-depth">Depth</label><input type="range" id="lfo1-depth" min="0" max="1" value="0.5" step="0.01"><span id="lfo1-depth-display" class="value-display">0.5</span> <label for="lfo1-destination">Destination</label> <select id="lfo1-destination"> <option value="none">None</option><option value="pitch">Osc Pitch (Vibrato)</option><option value="filterCutoff">Filter Env BaseFreq</option><option value="amplitude">Amplitude (Tremolo)</option> </select> </div>
             <!-- LFO 2 GROUP -->
             <div class="control-group"> <span class="group-title">LFO 2</span> <div class="flex items-center justify-center my-1"><label for="lfo2-enable" class="text-sm mr-2">Enable</label><input type="checkbox" id="lfo2-enable"><label for="lfo2-retrigger" class="text-sm ml-4 mr-1">Retrigger</label><input type="checkbox" id="lfo2-retrigger"></div> <label for="lfo2-wave">Waveform</label> <select id="lfo2-wave"> <option value="sine">Sine</option><option value="square">Square</option><option value="triangle">Triangle</option><option value="sawtooth">Sawtooth</option> <option value="pulse">Pulse</option><option value="pwm">PWM</option> </select> <div id="lfo2-pulse-width-controls" class="hidden"> <label for="lfo2-pulse-width">Pulse Width</label><input type="range" id="lfo2-pulse-width" min="0.01" max="0.99" value="0.5" step="0.01"><span id="lfo2-pulse-width-display" class="value-display">0.5</span> </div> <div id="lfo2-pwm-freq-controls" class="hidden"> <label for="lfo2-pwm-freq">PWM Freq</label><input type="range" id="lfo2-pwm-freq" min="0.1" max="20" value="2" step="0.1"><span id="lfo2-pwm-freq-display" class="value-display">2 Hz</span> </div> <label for="lfo2-rate">Rate</label><input type="range" id="lfo2-rate" min="0.1" max="30" value="5" step="0.1"><span id="lfo2-rate-display" class="value-display">5 Hz</span> <label for="lfo2-depth">Depth</label><input type="range" id="lfo2-depth" min="0" max="1" value="0.5" step="0.01"><span id="lfo2-depth-display" class="value-display">0.5</span> <label for="lfo2-destination">Destination</label> <select id="lfo2-destination"> <option value="none">None</option><option value="pitch">Osc Pitch (Vibrato)</option><option value="filterCutoff">Filter Env BaseFreq</option><option value="pulseWidth">Pulse Width</option><option value="amplitude">Amplitude (Tremolo)</option> </select> </div>
            <!-- EFFECTS -->
            <div class="control-group"><span class="group-title">Distortion</span><label for="dist-enable">Enable</label><input type="checkbox" id="dist-enable"><label for="dist-amount">Amount</label><input type="range" id="dist-amount" min="0" max="1" value="0.0" step="0.01"><span id="dist-amount-display" class="value-display">0.0</span><label for="dist-wet">Wet</label><input type="range" id="dist-wet" min="0" max="1" value="0.0" step="0.01"><span id="dist-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">BitCrusher</span><label for="crusher-enable">Enable</label><input type="checkbox" id="crusher-enable"><label for="crusher-bits">Bits</label><input type="range" id="crusher-bits" min="1" max="16" value="8" step="1"><span id="crusher-bits-display" class="value-display">8 bits</span><label for="crusher-wet">Wet</label><input type="range" id="crusher-wet" min="0" max="1" value="0.0" step="0.01"><span id="crusher-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">Ring Modulator</span><label for="ringmod-enable">Enable</label><input type="checkbox" id="ringmod-enable"><label for="ringmod-carrier-wave">Carrier Wave</label><select id="ringmod-carrier-wave"><option value="sine">Sine</option><option value="square">Square</option><option value="sawtooth">Sawtooth</option><option value="triangle">Triangle</option></select><label for="ringmod-frequency">Carrier Freq</label><input type="range" id="ringmod-frequency" min="1" max="2000" value="100" step="1"><span id="ringmod-frequency-display" class="value-display">100 Hz</span><label for="ringmod-wet">Wet</label><input type="range" id="ringmod-wet" min="0" max="1" value="0.0" step="0.01"><span id="ringmod-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">Chorus</span><label for="chorus-enable">Enable</label><input type="checkbox" id="chorus-enable"><label for="chorus-rate">Rate</label><input type="range" id="chorus-rate" min="0.1" max="8" value="1.5" step="0.1"><span id="chorus-rate-display" class="value-display">1.5 Hz</span><label for="chorus-depth">Depth</label><input type="range" id="chorus-depth" min="0" max="1" value="0.7" step="0.01"><span id="chorus-depth-display" class="value-display">0.7</span><label for="chorus-feedback">Feedback</label><input type="range" id="chorus-feedback" min="0" max="0.9" value="0.2" step="0.01"><span id="chorus-feedback-display" class="value-display">0.2</span><label for="chorus-wet">Wet</label><input type="range" id="chorus-wet" min="0" max="1" value="0.0" step="0.01"><span id="chorus-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">Phaser</span><label for="phaser-enable">Enable</label><input type="checkbox" id="phaser-enable"><label for="phaser-frequency">LFO Freq</label><input type="range" id="phaser-frequency" min="0.1" max="10" value="0.5" step="0.1"><span id="phaser-frequency-display" class="value-display">0.5 Hz</span><label for="phaser-octaves">Octaves</label><input type="range" id="phaser-octaves" min="1" max="8" value="3" step="0.1"><span id="phaser-octaves-display" class="value-display">3</span><label for="phaser-base-freq">Base Freq</label><input type="range" id="phaser-base-freq" min="100" max="1500" value="350" step="10"><span id="phaser-base-freq-display" class="value-display">350 Hz</span><label for="phaser-wet">Wet</label><input type="range" id="phaser-wet" min="0" max="1" value="0.0" step="0.01"><span id="phaser-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">Delay</span><label for="delay-enable">Enable</label><input type="checkbox" id="delay-enable"><label for="delay-time">Time</label><input type="range" id="delay-time" min="0.01" max="1" value="0.25" step="0.01"><span id="delay-time-display" class="value-display">0.25 s</span><label for="delay-feedback">Feedback</label><input type="range" id="delay-feedback" min="0" max="0.9" value="0.3" step="0.01"><span id="delay-feedback-display" class="value-display">0.3</span><label for="delay-wet">Wet</label><input type="range" id="delay-wet" min="0" max="1" value="0.0" step="0.01"><span id="delay-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">PingPongDelay</span><label for="pingpong-enable">Enable</label><input type="checkbox" id="pingpong-enable"><label for="pingpong-delay-time">Time</label><input type="range" id="pingpong-delay-time" min="0.01" max="1" value="0.35" step="0.01"><span id="pingpong-delay-time-display" class="value-display">0.35 s</span><label for="pingpong-feedback">Feedback</label><input type="range" id="pingpong-feedback" min="0" max="0.9" value="0.4" step="0.01"><span id="pingpong-feedback-display" class="value-display">0.4</span><label for="pingpong-wet">Wet</label><input type="range" id="pingpong-wet" min="0" max="1" value="0.0" step="0.01"><span id="pingpong-wet-display" class="value-display">0.0</span></div>
            <div class="control-group"><span class="group-title">Reverb</span><label for="reverb-enable">Enable</label><input type="checkbox" id="reverb-enable"><label for="reverb-decay">Decay</label><input type="range" id="reverb-decay" min="0.1" max="10" value="1.5" step="0.1"><span id="reverb-decay-display" class="value-display">1.5 s</span><label for="reverb-wet">Wet</label><input type="range" id="reverb-wet" min="0" max="1" value="0.0" step="0.01"><span id="reverb-wet-display" class="value-display">0.0</span></div>
        </div>

        <div class="keyboard-container">
            <div id="keyboard" class="keyboard select-none touch-manipulation"></div>
        </div>
        <div id="midi-status" class="text-sm mt-2">Initializing MIDI...</div>
        <p class="instructions">Computer Keyboard: Notes: 'A' row (white), 'Q' row (black). Octave: Z (down), X (up).</p>
    </div>
    <div id="audio-context-message-overlay" class="message-box-overlay"><div class="message-box-content"><p>Click "Start" to enable audio.</p><button id="start-audio-button">Start</button></div></div>

    <script>
        // --- Global Variables & Tone.js Objects ---
        let synth; 
        let startingOctave = 3; 
        let lfo1, lfo2;
        let tremoloEffect, distortionEffect, bitCrusherEffect, ringModulator, chorusEffect, phaserEffect, delayEffect, pingPongDelayEffect, reverbEffect;
        let masterVCA; // Master VCA
        let currentActiveSynthType = 'MonoSynth'; 
        let grainPlayerBuffer = null;
        let midiAccess = null;
        let userPresets = {};
        let sequencer;

        // --- DOM Element Grabbing (Centralized) ---
        const dom = { 
            oscType: document.getElementById('osc-type'), 
            oscPhase: document.getElementById('osc-phase'), oscPhaseDisplay: document.getElementById('osc-phase-display'),
            pulseControls: document.getElementById('pulse-controls'), pulseWidth: document.getElementById('pulse-width'), pulseWidthDisplay: document.getElementById('pulse-width-display'),
            pwmControls: document.getElementById('pwm-controls'), pwmSpeed: document.getElementById('pwm-speed'), pwmSpeedDisplay: document.getElementById('pwm-speed-display'), 
            fmControls: document.getElementById('fm-controls'), fmHarmonicity: document.getElementById('fm-harmonicity'), fmHarmonicityDisplay: document.getElementById('fm-harmonicity-display'), fmModIndex: document.getElementById('fm-mod-index'), fmModIndexDisplay: document.getElementById('fm-mod-index-display'), 
            supersawControls: document.getElementById('supersaw-controls'), supersawCount: document.getElementById('supersaw-count'), supersawCountDisplay: document.getElementById('supersaw-count-display'), supersawSpread: document.getElementById('supersaw-spread'), supersawSpreadDisplay: document.getElementById('supersaw-spread-display'),
            noiseControls: document.getElementById('noise-controls'), noiseType: document.getElementById('noise-type'),
            resonantBodyControls: document.getElementById('resonantbody-controls'), resonantBodyHarmonicity: document.getElementById('resonantbody-harmonicity'), resonantBodyHarmonicityDisplay: document.getElementById('resonantbody-harmonicity-display'), resonantBodyModIndex: document.getElementById('resonantbody-mod-index'), resonantBodyModIndexDisplay: document.getElementById('resonantbody-mod-index-display'),
            formantVoiceControls: document.getElementById('formantvoice-controls'), formantVoiceHarmonicity: document.getElementById('formantvoice-harmonicity'), formantVoiceHarmonicityDisplay: document.getElementById('formantvoice-harmonicity-display'), formantVoiceModIndex: document.getElementById('formantvoice-mod-index'), formantVoiceModIndexDisplay: document.getElementById('formantvoice-mod-index-display'),
            granularControls: document.getElementById('granular-controls'), granularFileInput: document.getElementById('granular-file-input'), granularLoop: document.getElementById('granular-loop'), granularGrainSize: document.getElementById('granular-grain-size'), granularGrainSizeDisplay: document.getElementById('granular-grain-size-display'), granularOverlap: document.getElementById('granular-overlap'), granularOverlapDisplay: document.getElementById('granular-overlap-display'), granularDetune: document.getElementById('granular-detune'), granularDetuneDisplay: document.getElementById('granular-detune-display'), granularPlaybackRate: document.getElementById('granular-playback-rate'), granularPlaybackRateDisplay: document.getElementById('granular-playback-rate-display'),
            granularLoopStart: document.getElementById('granular-loop-start'), granularLoopStartDisplay: document.getElementById('granular-loop-start-display'),
            granularLoopEnd: document.getElementById('granular-loop-end'), granularLoopEndDisplay: document.getElementById('granular-loop-end-display'),
            granularReverse: document.getElementById('granular-reverse'),
            octaveDisplay: document.getElementById('octave-display'), 
            octaveDownBtn: document.getElementById('octave-down-btn'), 
            octaveUpBtn: document.getElementById('octave-up-btn'),     
            volume: document.getElementById('volume'), volumeDisplay: document.getElementById('volume-display'), 
            ampEnvAttack: document.getElementById('amp-env-attack'), ampEnvAttackDisplay: document.getElementById('amp-env-attack-display'), ampEnvDecay: document.getElementById('amp-env-decay'), ampEnvDecayDisplay: document.getElementById('amp-env-decay-display'), ampEnvSustain: document.getElementById('amp-env-sustain'), ampEnvSustainDisplay: document.getElementById('amp-env-sustain-display'), ampEnvRelease: document.getElementById('amp-env-release'), ampEnvReleaseDisplay: document.getElementById('amp-env-release-display'),
            filterType: document.getElementById('filter-type'), filterCutoff: document.getElementById('filter-cutoff'), filterCutoffDisplay: document.getElementById('filter-cutoff-display'), filterResonance: document.getElementById('filter-resonance'), filterResonanceDisplay: document.getElementById('filter-resonance-display'), 
            filterEnvAttack: document.getElementById('filter-env-attack'), filterEnvAttackDisplay: document.getElementById('filter-env-attack-display'), filterEnvDecay: document.getElementById('filter-env-decay'), filterEnvDecayDisplay: document.getElementById('filter-env-decay-display'), filterEnvSustain: document.getElementById('filter-env-sustain'), filterEnvSustainDisplay: document.getElementById('filter-env-sustain-display'), filterEnvRelease: document.getElementById('filter-env-release'), filterEnvReleaseDisplay: document.getElementById('filter-env-release-display'), filterEnvAmount: document.getElementById('filter-env-amount'), filterEnvAmountDisplay: document.getElementById('filter-env-amount-display'),
            filterEnvCurve: document.getElementById('filter-env-curve'),
            lfo1Enable: document.getElementById('lfo1-enable'), lfo1Wave: document.getElementById('lfo1-wave'), lfo1Rate: document.getElementById('lfo1-rate'), lfo1RateDisplay: document.getElementById('lfo1-rate-display'), lfo1Depth: document.getElementById('lfo1-depth'), lfo1DepthDisplay: document.getElementById('lfo1-depth-display'), lfo1Destination: document.getElementById('lfo1-destination'), lfo1Retrigger: document.getElementById('lfo1-retrigger'),
            lfo1PulseWidthControls: document.getElementById('lfo1-pulse-width-controls'), lfo1PulseWidth: document.getElementById('lfo1-pulse-width'), lfo1PulseWidthDisplay: document.getElementById('lfo1-pulse-width-display'),
            lfo1PwmFreqControls: document.getElementById('lfo1-pwm-freq-controls'), lfo1PwmFreq: document.getElementById('lfo1-pwm-freq'), lfo1PwmFreqDisplay: document.getElementById('lfo1-pwm-freq-display'),
            lfo2Enable: document.getElementById('lfo2-enable'), lfo2Wave: document.getElementById('lfo2-wave'), lfo2Rate: document.getElementById('lfo2-rate'), lfo2RateDisplay: document.getElementById('lfo2-rate-display'), lfo2Depth: document.getElementById('lfo2-depth'), lfo2DepthDisplay: document.getElementById('lfo2-depth-display'), lfo2Destination: document.getElementById('lfo2-destination'), lfo2Retrigger: document.getElementById('lfo2-retrigger'),
            lfo2PulseWidthControls: document.getElementById('lfo2-pulse-width-controls'), lfo2PulseWidth: document.getElementById('lfo2-pulse-width'), lfo2PulseWidthDisplay: document.getElementById('lfo2-pulse-width-display'),
            lfo2PwmFreqControls: document.getElementById('lfo2-pwm-freq-controls'), lfo2PwmFreq: document.getElementById('lfo2-pwm-freq'), lfo2PwmFreqDisplay: document.getElementById('lfo2-pwm-freq-display'),
            distEnable: document.getElementById('dist-enable'), distAmount: document.getElementById('dist-amount'), distAmountDisplay: document.getElementById('dist-amount-display'), distWet: document.getElementById('dist-wet'), distWetDisplay: document.getElementById('dist-wet-display'), 
            crusherEnable: document.getElementById('crusher-enable'), crusherBits: document.getElementById('crusher-bits'), crusherBitsDisplay: document.getElementById('crusher-bits-display'), crusherWet: document.getElementById('crusher-wet'), crusherWetDisplay: document.getElementById('crusher-wet-display'),
            ringModEnable: document.getElementById('ringmod-enable'), ringModCarrierWave: document.getElementById('ringmod-carrier-wave'), ringModFrequency: document.getElementById('ringmod-frequency'), ringModFrequencyDisplay: document.getElementById('ringmod-frequency-display'), ringModWet: document.getElementById('ringmod-wet'), ringModWetDisplay: document.getElementById('ringmod-wet-display'),
            chorusEnable: document.getElementById('chorus-enable'), chorusRate: document.getElementById('chorus-rate'), chorusRateDisplay: document.getElementById('chorus-rate-display'), chorusDepth: document.getElementById('chorus-depth'), chorusDepthDisplay: document.getElementById('chorus-depth-display'), chorusFeedback: document.getElementById('chorus-feedback'), chorusFeedbackDisplay: document.getElementById('chorus-feedback-display'), chorusWet: document.getElementById('chorus-wet'), chorusWetDisplay: document.getElementById('chorus-wet-display'), 
            phaserEnable: document.getElementById('phaser-enable'), phaserFrequency: document.getElementById('phaser-frequency'), phaserFrequencyDisplay: document.getElementById('phaser-frequency-display'), phaserOctaves: document.getElementById('phaser-octaves'), phaserOctavesDisplay: document.getElementById('phaser-octaves-display'), phaserBaseFreq: document.getElementById('phaser-base-freq'), phaserBaseFreqDisplay: document.getElementById('phaser-base-freq-display'), phaserWet: document.getElementById('phaser-wet'), phaserWetDisplay: document.getElementById('phaser-wet-display'),
            delayEnable: document.getElementById('delay-enable'), delayTime: document.getElementById('delay-time'), delayTimeDisplay: document.getElementById('delay-time-display'), delayFeedback: document.getElementById('delay-feedback'), delayFeedbackDisplay: document.getElementById('delay-feedback-display'), delayWet: document.getElementById('delay-wet'), delayWetDisplay: document.getElementById('delay-wet-display'), 
            pingpongEnable: document.getElementById('pingpong-enable'), pingpongDelayTime: document.getElementById('pingpong-delay-time'), pingpongDelayTimeDisplay: document.getElementById('pingpong-delay-time-display'), pingpongFeedback: document.getElementById('pingpong-feedback'), pingpongFeedbackDisplay: document.getElementById('pingpong-feedback-display'), pingpongWet: document.getElementById('pingpong-wet'), pingpongWetDisplay: document.getElementById('pingpong-wet-display'),
            reverbEnable: document.getElementById('reverb-enable'), reverbDecay: document.getElementById('reverb-decay'), reverbDecayDisplay: document.getElementById('reverb-decay-display'), reverbWet: document.getElementById('reverb-wet'), reverbWetDisplay: document.getElementById('reverb-wet-display'), 
            keyboard: document.getElementById('keyboard'), audioContextMessageOverlay: document.getElementById('audio-context-message-overlay'), startAudioButton: document.getElementById('start-audio-button'), 
            midiStatus: document.getElementById('midi-status'),
            presetSelect: document.getElementById('preset-select'),
            presetNameInput: document.getElementById('preset-name-input'),
            savePresetButton: document.getElementById('save-preset-button'),
            sequencerEnable: document.getElementById('sequencer-enable'), sequencerRate: document.getElementById('sequencer-rate'), sequencerRateDisplay: document.getElementById('sequencer-rate-display'), sequencerGateProb: document.getElementById('sequencer-gate-prob'), sequencerGateProbDisplay: document.getElementById('sequencer-gate-prob-display'), sequencerNoteDuration: document.getElementById('sequencer-note-duration'), sequencerNoteDurationDisplay: document.getElementById('sequencer-note-duration-display'), sequencerPitchSpread: document.getElementById('sequencer-pitch-spread'), sequencerPitchSpreadDisplay: document.getElementById('sequencer-pitch-spread-display'), sequencerScale: document.getElementById('sequencer-scale'),
            sequencerDirection: document.getElementById('sequencer-direction'), sequencerRegen: document.getElementById('sequencer-regen'), sequencerSwing: document.getElementById('sequencer-swing'), sequencerSwingDisplay: document.getElementById('sequencer-swing-display'),
            midiInputSelect: document.getElementById('midi-input-select'),
            midiChannelSelect: document.getElementById('midi-channel-select')
        };
        
        for (const key in dom) { if (dom[key] === null) { console.error(`CRITICAL DOM ERROR: Element for dom.${key} not found!`); }}

        const paramDefinitions = { 
            'oscType': { elementId: 'osc-type', label: 'Osc Type', type: 'select', options: Array.from(dom.oscType.options).map(opt => opt.value), eventToDispatch: 'change' },
            'oscPhase': { elementId: 'osc-phase', label: 'Osc Phase', type: 'range', min:0, max:360, eventToDispatch: 'input'},
            'pulseWidth': { elementId: 'pulse-width', label: 'Pulse Width', type: 'range', min:0.01, max:0.99, eventToDispatch: 'input'},
            'pwmSpeed': { elementId: 'pwm-speed', label: 'PWM Speed', type: 'range', min: 0.1, max: 20, eventToDispatch: 'input'},
            'fmHarmonicity': { elementId: 'fm-harmonicity', label: 'FM Harm', type: 'range', min: 0.1, max: 10, eventToDispatch: 'input'},
            'fmModIndex': { elementId: 'fm-mod-index', label: 'FM Index', type: 'range', min: 1, max: 50, eventToDispatch: 'input'},
            'supersawCount': { elementId: 'supersaw-count', label: 'Saw Count', type: 'range', min: 2, max: 10, eventToDispatch: 'input'},
            'supersawSpread': { elementId: 'supersaw-spread', label: 'Saw Spread', type: 'range', min: 0, max: 100, eventToDispatch: 'input'},
            'noiseType': { elementId: 'noise-type', label: 'Noise Type', type: 'select', options: Array.from(dom.noiseType.options).map(opt => opt.value), eventToDispatch: 'change' },
            'resonantBodyHarmonicity': { elementId: 'resonantbody-harmonicity', label: 'Reso Harm', type: 'range', min: 0.1, max: 20, eventToDispatch: 'input'},
            'resonantBodyModIndex': { elementId: 'resonantbody-mod-index', label: 'Reso Index', type: 'range', min: 1, max: 100, eventToDispatch: 'input'},
            'formantVoiceHarmonicity': { elementId: 'formantvoice-harmonicity', label: 'Formant Harm', type: 'range', min: 0.1, max: 5, eventToDispatch: 'input'},
            'formantVoiceModIndex': { elementId: 'formantvoice-mod-index', label: 'Formant Index', type: 'range', min: 1, max: 30, eventToDispatch: 'input'},
            'granularLoop': { elementId: 'granular-loop', label: 'Granular Loop', type: 'checkbox', eventToDispatch: 'change'},
            'granularLoopStart': { elementId: 'granular-loop-start', label: 'Granular Loop Start', type: 'range', min: 0, max: 1, eventToDispatch: 'input'},
            'granularLoopEnd': { elementId: 'granular-loop-end', label: 'Granular Loop End', type: 'range', min: 0, max: 1, eventToDispatch: 'input'},
            'granularReverse': { elementId: 'granular-reverse', label: 'Granular Reverse', type: 'checkbox', eventToDispatch: 'change'},
            'granularGrainSize': { elementId: 'granular-grain-size', label: 'Grain Size', type: 'range', min: 0.01, max: 0.5, eventToDispatch: 'input'},
            'granularOverlap': { elementId: 'granular-overlap', label: 'Grain Overlap', type: 'range', min: -0.1, max: 0.4, eventToDispatch: 'input'},
            'granularDetune': { elementId: 'granular-detune', label: 'Grain Detune', type: 'range', min:0, max:1200, eventToDispatch: 'input'},
            'granularPlaybackRate': { elementId: 'granular-playback-rate', label: 'Grain Playback Rate', type: 'range', min:0.1, max:4, eventToDispatch: 'input'},
            'sequencerEnable': { elementId: 'sequencer-enable', label: 'Sequencer Enable', type: 'checkbox', eventToDispatch: 'change'},
            'sequencerRate': { elementId: 'sequencer-rate', label: 'Seq Rate', type: 'range', min:0.1, max:20, eventToDispatch: 'input'},
            'sequencerGateProb': { elementId: 'sequencer-gate-prob', label: 'Seq Gate Prob', type: 'range', min:0, max:100, eventToDispatch: 'input'},
            'sequencerNoteDuration': { elementId: 'sequencer-note-duration', label: 'Seq Note Dur', type: 'range', min:0.05, max:2, eventToDispatch: 'input'},
            'sequencerPitchSpread': { elementId: 'sequencer-pitch-spread', label: 'Seq Pitch Spread', type: 'range', min:0, max:24, eventToDispatch: 'input'},
            'sequencerScale': { elementId: 'sequencer-scale', label: 'Seq Scale', type: 'select', options: Array.from(dom.sequencerScale.options).map(opt => opt.value), eventToDispatch: 'change'},
            'sequencerDirection': { elementId: 'sequencer-direction', label: 'Seq Direction', type: 'select', options: Array.from(dom.sequencerDirection.options).map(opt => opt.value), eventToDispatch: 'change' },
            'sequencerSwing': { elementId: 'sequencer-swing', label: 'Seq Swing', type: 'range', min: 0, max: 1, eventToDispatch: 'input'},
            'masterVolume': { elementId: 'volume', label: 'Master Volume', type: 'range', min: -40, max: 0, eventToDispatch: 'input' },
            'ampEnvAttack': { elementId: 'amp-env-attack', label: 'Amp Attack', type: 'range', min: 0.005, max: 2, eventToDispatch: 'input' },
            'ampEnvDecay': { elementId: 'amp-env-decay', label: 'Amp Decay', type: 'range', min: 0.01, max: 2, eventToDispatch: 'input' },
            'ampEnvSustain': { elementId: 'amp-env-sustain', label: 'Amp Sustain', type: 'range', min: 0, max: 1, eventToDispatch: 'input' },
            'ampEnvRelease': { elementId: 'amp-env-release', label: 'Amp Release', type: 'range', min: 0.01, max: 5, eventToDispatch: 'input' },
            'filterType': { elementId: 'filter-type', label: 'Filter Type', type: 'select', options: Array.from(dom.filterType.options).map(opt => opt.value), eventToDispatch: 'change' },
            'filterEnvCurve': { elementId: 'filter-env-curve', label: 'Filter Env Curve', type: 'select', options: Array.from(dom.filterEnvCurve.options).map(opt => opt.value), eventToDispatch: 'change'},
            'filterCutoff': { elementId: 'filter-cutoff', label: 'Filter Cutoff', type: 'range', min: 20, max: 20000, eventToDispatch: 'input' },
            'filterResonance': { elementId: 'filter-resonance', label: 'Filter Reso', type: 'range', min: 0.1, max: 30, eventToDispatch: 'input' },
            'filterEnvAttack': { elementId: 'filter-env-attack', label: 'Filt Env Attack', type: 'range', min: 0.005, max: 2, eventToDispatch: 'input' },
            'filterEnvDecay': { elementId: 'filter-env-decay', label: 'Filt Env Decay', type: 'range', min: 0.01, max: 2, eventToDispatch: 'input' },
            'filterEnvSustain': { elementId: 'filter-env-sustain', label: 'Filt Env Sustain', type: 'range', min: 0, max: 1, eventToDispatch: 'input' },
            'filterEnvRelease': { elementId: 'filter-env-release', label: 'Filt Env Release', type: 'range', min: 0.01, max: 5, eventToDispatch: 'input' },
            'filterEnvAmount': { elementId: 'filter-env-amount', label: 'Filt Env Amt', type: 'range', min: -7, max: 7, eventToDispatch: 'input' },
            'lfo1Enable': { elementId: 'lfo1-enable', label: 'LFO1 Enable', type: 'checkbox', eventToDispatch: 'change' },
            'lfo1Retrigger': { elementId: 'lfo1-retrigger', label: 'LFO1 Retrigger', type: 'checkbox', eventToDispatch: 'change'},
            'lfo1Wave': { elementId: 'lfo1-wave', label: 'LFO1 Wave', type: 'select', options: Array.from(dom.lfo1Wave.options).map(opt => opt.value), eventToDispatch: 'change' },
            'lfo1PulseWidth': { elementId: 'lfo1-pulse-width', label: 'LFO1 Pulse Width', type: 'range', min:0.01, max:0.99, eventToDispatch: 'input'},
            'lfo1PwmFreq': { elementId: 'lfo1-pwm-freq', label: 'LFO1 PWM Freq', type: 'range', min:0.1, max:20, eventToDispatch: 'input'},
            'lfo1Rate': { elementId: 'lfo1-rate', label: 'LFO1 Rate', type: 'range', min: 0.1, max: 30, eventToDispatch: 'input' },
            'lfo1Depth': { elementId: 'lfo1-depth', label: 'LFO1 Depth', type: 'range', min: 0, max: 1, eventToDispatch: 'input' },
            'lfo1Destination': { elementId: 'lfo1-destination', label: 'LFO1 Dest', type: 'select', options: Array.from(dom.lfo1Destination.options).map(opt => opt.value), eventToDispatch: 'change' },
            'lfo2Enable': { elementId: 'lfo2-enable', label: 'LFO2 Enable', type: 'checkbox', eventToDispatch: 'change' },
            'lfo2Retrigger': { elementId: 'lfo2-retrigger', label: 'LFO2 Retrigger', type: 'checkbox', eventToDispatch: 'change'},
            'lfo2Wave': { elementId: 'lfo2-wave', label: 'LFO2 Wave', type: 'select', options: Array.from(dom.lfo2Wave.options).map(opt => opt.value), eventToDispatch: 'change' },
            'lfo2PulseWidth': { elementId: 'lfo2-pulse-width', label: 'LFO2 Pulse Width', type: 'range', min:0.01, max:0.99, eventToDispatch: 'input'},
            'lfo2PwmFreq': { elementId: 'lfo2-pwm-freq', label: 'LFO2 PWM Freq', type: 'range', min:0.1, max:20, eventToDispatch: 'input'},
            'lfo2Rate': { elementId: 'lfo2-rate', label: 'LFO2 Rate', type: 'range', min: 0.1, max: 30, eventToDispatch: 'input' },
            'lfo2Depth': { elementId: 'lfo2-depth', label: 'LFO2 Depth', type: 'range', min: 0, max: 1, eventToDispatch: 'input' },
            'lfo2Destination': { elementId: 'lfo2-destination', label: 'LFO2 Dest', type: 'select', options: Array.from(dom.lfo2Destination.options).map(opt => opt.value), eventToDispatch: 'change' },
            'distEnable': { elementId: 'dist-enable', label: 'Distortion Enable', type: 'checkbox', eventToDispatch: 'change'}, 'distAmount': { elementId: 'dist-amount', label: 'Distortion Amt', type: 'range', min:0, max:1, eventToDispatch: 'input'}, 'distWet': { elementId: 'dist-wet', label: 'Distortion Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'crusherEnable': { elementId: 'crusher-enable', label: 'BitCrush Enable', type: 'checkbox', eventToDispatch: 'change'}, 'crusherBits': { elementId: 'crusher-bits', label: 'BitCrush Bits', type: 'range', min:1, max:16, eventToDispatch: 'input'}, 'crusherWet': { elementId: 'crusher-wet', label: 'BitCrush Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'ringModEnable': { elementId: 'ringmod-enable', label: 'RingMod Enable', type: 'checkbox', eventToDispatch: 'change'}, 
            'ringModCarrierWave': { elementId: 'ringmod-carrier-wave', label: 'RingMod Carrier', type: 'select', options: ['sine', 'square', 'sawtooth', 'triangle'], eventToDispatch: 'change'},
            'ringModFrequency': { elementId: 'ringmod-frequency', label: 'RingMod Freq', type: 'range', min:1, max:2000, eventToDispatch: 'input'}, 
            'ringModWet': { elementId: 'ringmod-wet', label: 'RingMod Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'chorusEnable': { elementId: 'chorus-enable', label: 'Chorus Enable', type: 'checkbox', eventToDispatch: 'change'}, 'chorusRate': { elementId: 'chorus-rate', label: 'Chorus Rate', type: 'range', min:0.1, max:8, eventToDispatch: 'input'}, 'chorusDepth': { elementId: 'chorus-depth', label: 'Chorus Depth', type: 'range', min:0, max:1, eventToDispatch: 'input'}, 'chorusFeedback': { elementId: 'chorus-feedback', label: 'Chorus Fbk', type: 'range', min:0, max:0.9, eventToDispatch: 'input'}, 'chorusWet': { elementId: 'chorus-wet', label: 'Chorus Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'phaserEnable': { elementId: 'phaser-enable', label: 'Phaser Enable', type: 'checkbox', eventToDispatch: 'change'}, 'phaserFrequency': { elementId: 'phaser-frequency', label: 'Phaser Freq', type: 'range', min:0.1, max:10, eventToDispatch: 'input'}, 'phaserOctaves': { elementId: 'phaser-octaves', label: 'Phaser Octs', type: 'range', min:1, max:8, eventToDispatch: 'input'}, 'phaserBaseFreq': { elementId: 'phaser-base-freq', label: 'Phaser Base', type: 'range', min:100, max:1500, eventToDispatch: 'input'}, 'phaserWet': { elementId: 'phaser-wet', label: 'Phaser Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'delayEnable': { elementId: 'delay-enable', label: 'Delay Enable', type: 'checkbox', eventToDispatch: 'change'}, 'delayTime': { elementId: 'delay-time', label: 'Delay Time', type: 'range', min:0.01, max:1, eventToDispatch: 'input'}, 'delayFeedback': { elementId: 'delay-feedback', label: 'Delay Fbk', type: 'range', min:0, max:0.9, eventToDispatch: 'input'}, 'delayWet': { elementId: 'delay-wet', label: 'Delay Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'pingpongEnable': { elementId: 'pingpong-enable', label: 'PingPong Enable', type: 'checkbox', eventToDispatch: 'change'}, 'pingpongDelayTime': { elementId: 'pingpong-delay-time', label: 'PP Delay Time', type: 'range', min:0.01, max:1, eventToDispatch: 'input'}, 'pingpongFeedback': { elementId: 'pingpong-feedback', label: 'PP Delay Fbk', type: 'range', min:0, max:0.9, eventToDispatch: 'input'}, 'pingpongWet': { elementId: 'pingpong-wet', label: 'PP Delay Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
            'reverbEnable': { elementId: 'reverb-enable', label: 'Reverb Enable', type: 'checkbox', eventToDispatch: 'change'}, 'reverbDecay': { elementId: 'reverb-decay', label: 'Reverb Decay', type: 'range', min:0.1, max:10, eventToDispatch: 'input'}, 'reverbWet': { elementId: 'reverb-wet', label: 'Reverb Wet', type: 'range', min:0, max:1, eventToDispatch: 'input'},
        };
        
        const notesLayout = [ { name: 'C', freqName: 'C', type: 'white' }, { name: 'C#', freqName: 'C#', type: 'black' },{ name: 'D', freqName: 'D', type: 'white' }, { name: 'D#', freqName: 'D#', type: 'black' },{ name: 'E', freqName: 'E', type: 'white' }, { name: 'F', freqName: 'F', type: 'white' },{ name: 'F#', freqName: 'F#', type: 'black' }, { name: 'G', freqName: 'G', type: 'white' },{ name: 'G#', freqName: 'G#', type: 'black' }, { name: 'A', freqName: 'A', type: 'white' },{ name: 'A#', freqName: 'A#', type: 'black' }, { name: 'B', freqName: 'B', type: 'white' } ];
        const noteNamesSharp = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const pressedComputerKeys = new Set();
        const computerKeyNoteMapping = { 'a': 'C', 's': 'D', 'd': 'E', 'f': 'F', 'g': 'G', 'h': 'A', 'j': 'B', 'w': 'C#', 'e': 'D#', 't': 'F#', 'y': 'G#', 'u': 'A#'};
        
        const scales = {
            chromatic: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11],
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10],
            pentatonicMajor: [0, 2, 4, 7, 9],
            pentatonicMinor: [0, 3, 5, 7, 10]
        };

        // --- Helper Functions ---
        function showMessage(overlayElem, message, buttonText, callback) { console.log("Showing message:", message); const p = overlayElem.querySelector('p'); const btn = overlayElem.querySelector('button'); if (p) p.innerHTML = message.replace(/\n/g, '<br>'); if (btn) btn.textContent = buttonText; overlayElem.classList.add('visible'); return new Promise((resolve) => { const clickHandler = async () => { overlayElem.classList.remove('visible'); btn.removeEventListener('click', clickHandler); if (callback) await callback(); resolve(); }; btn.addEventListener('click', clickHandler); }); }
        function updateSliderDisplay(slider, displayElement, unit = '', decimals = 1) { if (!slider || !displayElement) { console.warn("updateSliderDisplay: Missing slider or displayElement for unit:", unit); return; } const value = parseFloat(slider.value).toFixed(decimals); displayElement.textContent = `${value} ${unit}`; }
        
        function releaseAndRefocus(event) {
            releaseAllComputerKeys(); 
            if (event && event.target && typeof event.target.blur === 'function') {
                event.target.blur();
            }
            if (document.body.tabIndex === -1) { 
                setTimeout(() => {
                    document.body.focus();
                }, 0); 
            }
        }
        function releaseAllComputerKeys() { if (pressedComputerKeys.size > 0) { const keysToRelease = new Set(pressedComputerKeys); keysToRelease.forEach(key => { if (computerKeyNoteMapping[key]) { const noteBase = computerKeyNoteMapping[key]; const fullNoteName = `${noteBase}${startingOctave}`; releaseNote(fullNoteName); } }); pressedComputerKeys.clear(); } }


        // --- Audio Initialization and Synth Configuration ---
        async function initializeAudio() {
            console.log("AUDIO_INIT: Starting. Tone.context.state:", Tone.context.state);
            if (Tone.context.state !== 'running') {
                try { await Tone.start(); console.log("AUDIO_INIT: Tone.start() OK. State:", Tone.context.state); }
                catch (error) { console.error("AUDIO_INIT_ERROR: Tone.start() failed:", error); showMessage(dom.audioContextMessageOverlay, "Error initializing audio.", "Close", () => {}); return false; }
            }
            if (!tremoloEffect) { 
                try {
                    console.log("AUDIO_INIT: Creating ALL effect nodes...");
                    lfo1 = new Tone.LFO({ frequency: parseFloat(dom.lfo1Rate.value), type: dom.lfo1Wave.value, min: -1, max: 1 });
                    lfo2 = new Tone.LFO({ frequency: parseFloat(dom.lfo2Rate.value), type: dom.lfo2Wave.value, min: -1, max: 1 });
                    tremoloEffect = new Tone.Tremolo({ frequency: parseFloat(dom.lfo1Rate.value), type: dom.lfo1Wave.value, depth: 0, spread: 0 });
                    distortionEffect = new Tone.Distortion(parseFloat(dom.distAmount.value));
                    bitCrusherEffect = new Tone.BitCrusher(parseInt(dom.crusherBits.value));
                    ringModulator = new Tone.RingModulator({frequency: 100, harmonicity: 3});
                    chorusEffect = new Tone.Chorus({ frequency: parseFloat(dom.chorusRate.value), depth: parseFloat(dom.chorusDepth.value), feedback: parseFloat(dom.chorusFeedback.value), delayTime: 3.5, type: "sine" });
                    phaserEffect = new Tone.Phaser({ frequency: parseFloat(dom.phaserFrequency.value), octaves: parseFloat(dom.phaserOctaves.value), baseFrequency: parseFloat(dom.phaserBaseFreq.value) });
                    delayEffect = new Tone.FeedbackDelay({ delayTime: parseFloat(dom.delayTime.value), feedback: parseFloat(dom.delayFeedback.value) });
                    pingPongDelayEffect = new Tone.PingPongDelay({ delayTime: parseFloat(dom.pingpongDelayTime.value), feedback: parseFloat(dom.pingpongFeedback.value) });
                    reverbEffect = new Tone.Reverb({ decay: parseFloat(dom.reverbDecay.value), preDelay: 0.01 });
                    masterVCA = new Tone.Gain().toDestination();
                    masterVCA.gain.value = Tone.dbToGain(parseFloat(dom.volume.value));
                    console.log("AUDIO_INIT: All effect nodes created.");

                    distortionEffect.wet.value = dom.distEnable.checked ? parseFloat(dom.distWet.value) : 0; 
                    bitCrusherEffect.wet.value = dom.crusherEnable.checked ? parseFloat(dom.crusherWet.value) : 0; 
                    ringModulator.wet.value = dom.ringModEnable.checked ? parseFloat(dom.ringModWet.value) : 0;
                    chorusEffect.wet.value = dom.chorusEnable.checked ? parseFloat(dom.chorusWet.value) : 0; 
                    phaserEffect.wet.value = dom.phaserEnable.checked ? parseFloat(dom.phaserWet.value) : 0; 
                    delayEffect.wet.value = dom.delayEnable.checked ? parseFloat(dom.delayWet.value) : 0; 
                    pingPongDelayEffect.wet.value = dom.pingpongEnable.checked ? parseFloat(dom.pingpongWet.value) : 0; 
                    reverbEffect.wet.value = dom.reverbEnable.checked ? parseFloat(dom.reverbWet.value) : 0;

                } catch (error) { console.error("AUDIO_INIT_ERROR: Creating effect nodes failed:", error); return false; }
            }
            
            updateOscillatorType(); 
            
            console.log(`AUDIO_INIT: PRE-TEST_SOUND. Tone.context.state: ${Tone.context.state}. Synth exists: ${!!synth}. Synth type: ${currentActiveSynthType}`);
            if (synth && Tone.context.state === 'running' && currentActiveSynthType !== 'GrainPlayer') { 
                if(typeof synth.triggerAttackRelease === 'function'){
                    synth.triggerAttackRelease("C4", "8n", Tone.now() + 0.1); 
                    console.log("AUDIO_INIT: TEST SOUND (C4) triggered for PolySynth.");
                } else {
                     console.warn("AUDIO_INIT: TEST SOUND NOT TRIGGERED - synth.triggerAttackRelease is not a function on current synth object.");
                }
            } else { console.warn("AUDIO_INIT: TEST SOUND NOT TRIGGERED (or Granular mode active or synth not ready)."); }
            
            await initializeMIDI();
            initializeSequencer();
            
            console.log("AUDIO_INIT: Initialization finished.");
            return true;
        }
        
        function updateOscillatorType() {
            if (!Tone.context || Tone.context.state !== 'running') { console.warn("UPDATE_OSC_TYPE_WARN: AudioContext not running."); return; }
            const newSelectedOscType = dom.oscType.value;
            let newActiveSynthType = (newSelectedOscType === 'granular' || newSelectedOscType === 'noise') ? 'OneShot' : 'PolySynth'; 
            if(newSelectedOscType === 'granular') newActiveSynthType = 'GrainPlayer';


            console.log("UPDATE_OSC_TYPE: Selected type:", newSelectedOscType, "Required synth type:", newActiveSynthType);
            
            // Hide all oscillator-specific controls by default
            document.querySelectorAll('.osc-specific-controls').forEach(el => el.classList.add('hidden'));

            // Show controls for the selected oscillator type
            switch (newSelectedOscType) {
                case 'pulse': dom.pulseControls.classList.remove('hidden'); break;
                case 'pwm': dom.pwmControls.classList.remove('hidden'); break;
                case 'fmsine': case 'resonantbody': case 'formantvoice': dom.fmControls.classList.remove('hidden'); break;
                case 'supersaw': dom.supersawControls.classList.remove('hidden'); break; 
                case 'noise': dom.noiseControls.classList.remove('hidden'); break;
                case 'granular': dom.granularControls.classList.remove('hidden'); break;
            }
            if(newSelectedOscType !== 'noise' && newSelectedOscType !== 'granular') {
                dom.oscPhase.parentElement.classList.remove('hidden');
            }
            
            if (currentActiveSynthType !== newActiveSynthType || !synth || (synth && synth.disposed)) { 
                console.log("UPDATE_OSC_TYPE: Synth type change needed or first init/disposed. Old active type:", currentActiveSynthType, "New active type:", newActiveSynthType);

                if (synth && !synth.disposed) {
                    console.log("UPDATE_OSC_TYPE: Disposing old synth of type", currentActiveSynthType);
                    if (typeof synth.releaseAll === 'function') synth.releaseAll();
                    synth.disconnect(); 
                    synth.dispose(); 
                    synth = null;
                }

                if (newActiveSynthType === 'GrainPlayer') {
                    synth = new Tone.GrainPlayer(); 
                    console.log("UPDATE_OSC_TYPE: New GrainPlayer instance created.");
                    if (grainPlayerBuffer && grainPlayerBuffer.loaded) {
                        synth.buffer = grainPlayerBuffer;
                        console.log("UPDATE_OSC_TYPE: Existing buffer assigned to new GrainPlayer.");
                    } else {
                        dom.midiStatus.textContent = "Load WAV for Granular";
                        console.warn("UPDATE_OSC_TYPE: GrainPlayer created, but needs a buffer. Load a WAV file.");
                    }
                } else if (newSelectedOscType === 'noise') {
                    synth = new Tone.NoiseSynth();
                }
                else { 
                    synth = new Tone.PolySynth(Tone.MonoSynth); 
                    console.log("UPDATE_OSC_TYPE: New PolySynth(MonoSynth) created.");
                }
                currentActiveSynthType = newActiveSynthType; 
            }
            
            if (synth && !synth.disposed) { 
                 applyCurrentOscillatorSpecificSettings(newSelectedOscType);
                 applyAudioChain(); 
                 updateLFO1Connections();
                 updateLFO2Connections();
            } else if (newActiveSynthType === 'GrainPlayer' && !grainPlayerBuffer) {
                applyAudioChain(); 
            }
        }


        function applyCurrentOscillatorSpecificSettings(selectedOscType) {
            if (!synth || synth.disposed) { console.warn("APPLY_OSC_SETTINGS_WARN: Synth not ready or disposed for type:", selectedOscType); return; }
            console.log("APPLY_OSC_SETTINGS: Applying for type:", selectedOscType, "to current synth type:", currentActiveSynthType);

            if (synth instanceof Tone.PolySynth || synth instanceof Tone.NoiseSynth) { 
                let settingsForSynthSet = {
                    envelope: { 
                        attack: parseFloat(dom.ampEnvAttack.value),
                        decay: parseFloat(dom.ampEnvDecay.value),
                        sustain: parseFloat(dom.ampEnvSustain.value),
                        release: parseFloat(dom.ampEnvRelease.value),
                    }
                };
                if(synth instanceof Tone.PolySynth){
                    let filterTypeString = "lowpass"; let filterRolloff = -24; 
                    const selectedUIFilterType = dom.filterType.value;
                    if (selectedUIFilterType !== "none") {
                        switch(selectedUIFilterType) { 
                            case 'moog': filterTypeString = 'lowpass'; filterRolloff = -24; break; 
                            case 'ms20lp': filterTypeString = 'lowpass'; filterRolloff = -12; break; 
                            case 'ms20hp': filterTypeString = 'highpass'; filterRolloff = -12; break; 
                            case '303lp': filterTypeString = 'lowpass'; filterRolloff = -24; break; 
                            case 'bandpass12': filterTypeString = 'bandpass'; filterRolloff = -12; break; 
                            case 'bandpass24': filterTypeString = 'bandpass'; filterRolloff = -24; break; 
                            case 'notch12': filterTypeString = 'notch'; filterRolloff = -12; break; 
                            case 'notch24': filterTypeString = 'notch'; filterRolloff = -24; break; 
                            case 'allpass': filterTypeString = 'allpass'; filterRolloff = -12; break;
                        }
                        settingsForSynthSet.filter = { type: filterTypeString, Q: parseFloat(dom.filterResonance.value), rolloff: filterRolloff };
                        settingsForSynthSet.filterEnvelope = { attack: parseFloat(dom.filterEnvAttack.value), decay: parseFloat(dom.filterEnvDecay.value), sustain: parseFloat(dom.filterEnvSustain.value), release: parseFloat(dom.filterEnvRelease.value), baseFrequency: parseFloat(dom.filterCutoff.value), octaves: parseFloat(dom.filterEnvAmount.value), exponent: dom.filterEnvCurve.value === 'linear' ? 1 : 2 };
                    } else { settingsForSynthSet.filter = { type: 'lowpass', Q: 0.1, frequency: 20000, rolloff: -12 }; settingsForSynthSet.filterEnvelope = { attack:0.005, decay:0.01, sustain:1, release:0.01, baseFrequency: 20000, octaves: 0}; }

                    let monoSynthOscSettings = {};
                    switch (selectedOscType) { 
                        case 'sine': case 'square': case 'triangle': case 'sawtooth': monoSynthOscSettings = { type: selectedOscType, phase: parseFloat(dom.oscPhase.value) }; break; 
                        case 'pulse': monoSynthOscSettings = { type: 'pulse', width: parseFloat(dom.pulseWidth.value), phase: parseFloat(dom.oscPhase.value) }; break;
                        case 'pwm': monoSynthOscSettings = { type: 'pwm', modulationFrequency: parseFloat(dom.pwmSpeed.value), phase: parseFloat(dom.oscPhase.value) }; break; 
                        case 'fmsine': monoSynthOscSettings = { type: 'fmsine', harmonicity: parseFloat(dom.fmHarmonicity.value), modulationIndex: parseFloat(dom.fmModIndex.value), modulationType: 'sine', phase: parseFloat(dom.oscPhase.value) }; break; 
                        case 'amsine': monoSynthOscSettings = { type: 'amsine', harmonicity: 1, modulationType: 'square', phase: parseFloat(dom.oscPhase.value) }; break; 
                        case 'supersaw': monoSynthOscSettings = { type: 'fatsawtooth', count: parseInt(dom.supersawCount.value), spread: parseFloat(dom.supersawSpread.value), phase: parseFloat(dom.oscPhase.value) }; break; 
                        case 'resonantbody': monoSynthOscSettings = { type: 'fmsine', harmonicity: parseFloat(dom.resonantBodyHarmonicity.value), modulationIndex: parseFloat(dom.resonantBodyModIndex.value), modulationType: 'sine', phase: parseFloat(dom.oscPhase.value) }; break; 
                        case 'formantvoice': monoSynthOscSettings = { type: 'fmsine', harmonicity: parseFloat(dom.formantVoiceHarmonicity.value), modulationIndex: parseFloat(dom.formantVoiceModIndex.value), modulationType: 'triangle', phase: parseFloat(dom.oscPhase.value) }; break; 
                        default: monoSynthOscSettings = { type: 'sine' }; 
                    }
                    settingsForSynthSet.oscillator = monoSynthOscSettings;
                } else if (synth instanceof Tone.NoiseSynth){
                     settingsForSynthSet.noise = { type: dom.noiseType.value };
                }

                try { synth.set(settingsForSynthSet); console.log("APPLY_OSC_SETTINGS: Applied settings to synth:", settingsForSynthSet); } 
                catch(e) { console.error("APPLY_OSC_SETTINGS_ERROR: Failed to set options", selectedOscType, settingsForSynthSet, e); }
            } else if (synth instanceof Tone.GrainPlayer && selectedOscType === 'granular' && synth.loaded) {
                synth.loop = dom.granularLoop.checked;
                if (synth.buffer) { 
                    synth.loopStart = parseFloat(dom.granularLoopStart.value) * synth.buffer.duration;
                    synth.loopEnd = parseFloat(dom.granularLoopEnd.value) * synth.buffer.duration;
                }
                synth.reverse = dom.granularReverse.checked;
                synth.grainSize = parseFloat(dom.granularGrainSize.value);
                synth.overlap = parseFloat(dom.granularOverlap.value);
                synth.detune = parseFloat(dom.granularDetune.value);
                synth.playbackRate = parseFloat(dom.granularPlaybackRate.value);
                console.log("APPLY_OSC_SETTINGS: Applied to GrainPlayer:", {loop: synth.loop, grainSize: synth.grainSize, overlap: synth.overlap, detune:synth.detune, playbackRate: synth.playbackRate, loopStart: synth.loopStart, loopEnd: synth.loopEnd, reverse: synth.reverse});
            } else if (synth instanceof Tone.GrainPlayer && selectedOscType === 'granular' && (!synth.loaded)) {
                console.log("APPLY_OSC_SETTINGS: GrainPlayer selected but buffer not loaded or synth not ready. Waiting for file.");
            }
        }
        
        function applyAudioChain() { 
            const allEffectNodes = [tremoloEffect, ringModulator, distortionEffect, bitCrusherEffect, chorusEffect, phaserEffect, delayEffect, pingPongDelayEffect, reverbEffect];
            allEffectNodes.forEach(node => { if(node && !node.disposed) try { node.disconnect(); } catch(e){} }); 
            if (!synth || synth.disposed) { console.warn("APPLY_CHAIN_WARN: Synth object is null or disposed, cannot build audio chain."); return; } 

            console.log("APPLY_CHAIN: Rebuilding audio chain..."); 
            
            let currentNode = synth; 

            currentNode.connect(ringModulator); currentNode = ringModulator;
            currentNode.connect(tremoloEffect); currentNode = tremoloEffect; 
            if (dom.distEnable.checked && parseFloat(dom.distWet.value) > 0) { distortionEffect.wet.value = parseFloat(dom.distWet.value); currentNode.connect(distortionEffect); currentNode = distortionEffect; } else { distortionEffect.wet.value = 0; } 
            if (dom.crusherEnable.checked && parseFloat(dom.crusherWet.value) > 0) { bitCrusherEffect.wet.value = parseFloat(dom.crusherWet.value); currentNode.connect(bitCrusherEffect); currentNode = bitCrusherEffect; } else { bitCrusherEffect.wet.value = 0; }  
            if (dom.chorusEnable.checked && parseFloat(dom.chorusWet.value) > 0) { chorusEffect.wet.value = parseFloat(dom.chorusWet.value); currentNode.connect(chorusEffect); currentNode = chorusEffect; } else { chorusEffect.wet.value = 0; } 
            if (dom.phaserEnable.checked && parseFloat(dom.phaserWet.value) > 0) { phaserEffect.wet.value = parseFloat(dom.phaserWet.value); currentNode.connect(phaserEffect); currentNode = phaserEffect; } else { phaserEffect.wet.value = 0; } 
            if (dom.delayEnable.checked && parseFloat(dom.delayWet.value) > 0) { delayEffect.wet.value = parseFloat(dom.delayWet.value); currentNode.connect(delayEffect); currentNode = delayEffect; } else { delayEffect.wet.value = 0; } 
            if (dom.pingpongEnable.checked && parseFloat(dom.pingpongWet.value) > 0) { pingPongDelayEffect.wet.value = parseFloat(dom.pingpongWet.value); currentNode.connect(pingPongDelayEffect); currentNode = pingPongDelayEffect; } else { pingPongDelayEffect.wet.value = 0; } 
            if (dom.reverbEnable.checked && parseFloat(dom.reverbWet.value) > 0) { reverbEffect.wet.value = parseFloat(dom.reverbWet.value); currentNode.connect(reverbEffect); currentNode = reverbEffect; } else { reverbEffect.wet.value = 0; } 
            currentNode.connect(masterVCA);
            console.log("APPLY_CHAIN: Finalized. Last node before destination:", currentNode.name || currentNode.constructor.name); 
        }
        function updateLFO1Connections() { /* ... (same) ... */ if (!lfo1 || !synth || synth.disposed || !tremoloEffect) { console.warn("LFO1_CONN_WARN: Node(s) not ready."); return; } const isEnabled = dom.lfo1Enable.checked; lfo1.retrigger = dom.lfo1Retrigger.checked; const rate = parseFloat(dom.lfo1Rate.value); const depth = parseFloat(dom.lfo1Depth.value); const lfoWave = dom.lfo1Wave.value; const destination = dom.lfo1Destination.value; lfo1.frequency.value = rate; lfo1.type = lfoWave; dom.lfo1PulseWidthControls.classList.toggle('hidden', lfoWave !== 'pulse'); dom.lfo1PwmFreqControls.classList.toggle('hidden', lfoWave !== 'pwm'); if (lfoWave === 'pulse') { lfo1.width.value = parseFloat(dom.lfo1PulseWidth.value); } else if (lfoWave === 'pwm') { lfo1.modulationFrequency.value = parseFloat(dom.lfo1PwmFreq.value); } try { lfo1.disconnect(); } catch(e){} tremoloEffect.depth.value = 0; tremoloEffect.wet.value = 0; if (isEnabled) { if (lfo1.state !== "started") lfo1.start(); switch (destination) { case 'pitch': if(synth.detune) {lfo1.set({min:-100 * depth, max: 100*depth}); lfo1.connect(synth.detune);} else { console.log("LFO1 to Pitch: Not applicable on current synth.");} break; case 'filterCutoff': if (synth.filter && synth.filter.frequency) { lfo1.set({min: -5000 * depth, max: 5000 * depth}); lfo1.connect(synth.filter.frequency); } else { console.log("LFO1 to Filter: Not applicable on current synth.");} break; case 'amplitude': tremoloEffect.frequency.value = rate; let tremoloLfoType = (lfoWave === 'pulse' || lfoWave === 'pwm') ? 'square' : lfoWave; tremoloEffect.type = tremoloLfoType; tremoloEffect.depth.value = depth; tremoloEffect.wet.value = 1; break; default: break;} } else { if (lfo1.state === "started") lfo1.stop(); }}
        function updateLFO2Connections() {
             if (!lfo2 || !synth || synth.disposed) { console.warn("LFO2_CONN_WARN: Node(s) not ready."); return; } const isEnabled = dom.lfo2Enable.checked; lfo2.retrigger = dom.lfo2Retrigger.checked; const rate = parseFloat(dom.lfo2Rate.value); const depth = parseFloat(dom.lfo2Depth.value); const lfoWave = dom.lfo2Wave.value; const destination = dom.lfo2Destination.value; lfo2.frequency.value = rate; lfo2.type = lfoWave; dom.lfo2PulseWidthControls.classList.toggle('hidden', lfoWave !== 'pulse'); dom.lfo2PwmFreqControls.classList.toggle('hidden', lfoWave !== 'pwm'); if (lfoWave === 'pulse') { lfo2.width.value = parseFloat(dom.lfo2PulseWidth.value); } else if (lfoWave === 'pwm') { lfo2.modulationFrequency.value = parseFloat(dom.lfo2PwmFreq.value); } 
             try { if(lfo2.state === "started") lfo2.disconnect(); } catch(e){}

            if (isEnabled) { 
                if (lfo2.state !== "started") lfo2.start(); 
                switch (destination) { 
                    case 'pitch': if(synth.detune) {lfo2.set({min:-100 * depth, max: 100*depth}); lfo2.connect(synth.detune);} break; 
                    case 'filterCutoff': if (synth.filter && synth.filter.frequency) { lfo2.set({min: -5000 * depth, max: 5000 * depth}); lfo2.connect(synth.filter.frequency); } break; 
                    case 'pulseWidth': if (synth instanceof Tone.PolySynth && dom.oscType.value === 'pulse' && synth.get().oscillator.width) {lfo2.set({min: 0, max: depth}); lfo2.connect(synth.get().oscillator.width);} break;
                    case 'amplitude': tremoloEffect.frequency.value = rate; let tremoloLfoType = (lfoWave === 'pulse' || lfoWave === 'pwm') ? 'square' : lfoWave; tremoloEffect.type = tremoloLfoType; tremoloEffect.depth.value = depth; tremoloEffect.wet.value = 1; break; default: break;} 
            } else { 
                if (lfo2.state === "started") lfo2.stop(); 
            }
        }
        function createOnScreenKeyboard() { /* ... (same) ... */ dom.keyboard.innerHTML = ''; let currentXOffset = 0; const whiteKeyWidth = 38; for (let oct = 0; oct < 4; oct++) { notesLayout.forEach((noteLayout, index) => { const keyElement = document.createElement('div'); keyElement.classList.add('key'); const currentKeyOctave = startingOctave + oct; keyElement.dataset.fullNote = `${noteLayout.freqName}${currentKeyOctave}`; keyElement.textContent = noteLayout.name; if (noteLayout.type === 'white') { keyElement.classList.add('white-key'); keyElement.style.left = `${currentXOffset}px`; dom.keyboard.appendChild(keyElement); currentXOffset += whiteKeyWidth; } else { keyElement.classList.add('black-key'); keyElement.style.left = `${currentXOffset - (whiteKeyWidth/2)}px`; dom.keyboard.appendChild(keyElement); } const playNoteHandler = async (event) => { event.preventDefault(); const noteToPlay = keyElement.dataset.fullNote; if (Tone.context.state !== 'running' || !synth) { await showMessage(dom.audioContextMessageOverlay, "Audio not active.", "Start", async () => { if(await initializeAudio()) playNote(noteToPlay); }); return; } playNote(noteToPlay); }; const releaseNoteHandler = (event) => { event.preventDefault(); const noteToRelease = keyElement.dataset.fullNote; releaseNote(noteToRelease); }; keyElement.addEventListener('mousedown', playNoteHandler); keyElement.addEventListener('touchstart', playNoteHandler, { passive: false }); keyElement.addEventListener('mouseup', releaseNoteHandler); keyElement.addEventListener('touchend', releaseNoteHandler, { passive: false }); keyElement.addEventListener('mouseleave', (e) => { if (keyElement.classList.contains('active')) { const noteToRelease = keyElement.dataset.fullNote; releaseNote(noteToRelease);}}); }); } dom.keyboard.style.width = `${currentXOffset}px`;}
        function updateKeyVisualState(fullNoteName, isActive) { /* ... (same) ... */ const keys = dom.keyboard.querySelectorAll('.key'); keys.forEach(key => { if (key.dataset.fullNote === fullNoteName) { key.classList.toggle('active', isActive); } }); }
        function playNote(fullNoteName, velocity = 0.75) { /* ... (same) ... */ if (!synth || (synth.disposed && !(synth instanceof Tone.GrainPlayer && synth.loaded === false) ) || Tone.context.state !== 'running') { console.warn("PlayNote: Synth not ready, disposed, or audio context not running. Synth:", synth, "Context state:", Tone.context.state); return; } try { if (synth instanceof Tone.GrainPlayer) { if (synth.loaded) { applyCurrentOscillatorSpecificSettings('granular'); let duration; let offset = 0; if (synth.loop && synth.buffer) { offset = synth.loopStart; let loopEndSec = synth.loopEnd; duration = loopEndSec > offset ? loopEndSec - offset : synth.buffer.duration - offset + loopEndSec; if (duration <= 0) duration = synth.buffer.duration - offset; if (duration <= 0 || isNaN(duration)) duration = undefined; } else if (synth.buffer) { duration = synth.buffer.duration; } else { console.warn("PlayNote (GrainPlayer): Buffer not available for duration calculation."); return; } synth.start(Tone.now(), offset, duration); } else { console.warn("PlayNote (GrainPlayer): Buffer not loaded. Cannot play."); return; } } else if (synth instanceof Tone.NoiseSynth){ synth.triggerAttack(Tone.now()); } else if (synth instanceof Tone.PolySynth) { if (typeof synth.triggerAttack === 'function') { synth.triggerAttack(fullNoteName, Tone.now(), velocity); } else { console.error("PLAYNOTE_FATAL: synth.triggerAttack is NOT a function on PolySynth instance.", synth); } } else if (synth) { console.error("PLAYNOTE_ERROR: Synth object is of unexpected type or not fully initialized:", synth); } else { console.warn("PlayNote: Synth object is not available."); } updateKeyVisualState(fullNoteName, true); } catch (error) { console.error(`Error playing ${fullNoteName}:`, error); } }
        function releaseNote(fullNoteName) { /* ... (same) ... */ if (!synth || synth.disposed || Tone.context.state !== 'running') { console.warn("ReleaseNote: Synth not ready or disposed."); return; } try { if (synth instanceof Tone.GrainPlayer) { if (synth.loaded && typeof synth.stop === 'function') synth.stop(Tone.now() + 0.05); else console.warn("ReleaseNote (GrainPlayer): Buffer not loaded or stop method missing."); } else if (synth instanceof Tone.NoiseSynth){ synth.triggerRelease(Tone.now() + 0.05); } else if (synth instanceof Tone.PolySynth) { if (typeof synth.triggerRelease === 'function') { synth.triggerRelease(fullNoteName, Tone.now() + 0.05); } else { console.error("RELEASENOTE_FATAL: synth.triggerRelease is NOT a function on PolySynth instance.", synth); } } else if (synth) { console.error("RELEASENOTE_ERROR: Synth object is of unexpected type or not fully initialized:", synth); } updateKeyVisualState(fullNoteName, false); } catch (error) { console.error(`Error releasing ${fullNoteName}:`, error); } }
        function releaseAllComputerKeys() { if (pressedComputerKeys.size > 0) { const keysToRelease = new Set(pressedComputerKeys); keysToRelease.forEach(key => { if (computerKeyNoteMapping[key]) { const noteBase = computerKeyNoteMapping[key]; const fullNoteName = `${noteBase}${startingOctave}`; releaseNote(fullNoteName); } }); pressedComputerKeys.clear(); } }
        window.addEventListener('keydown', (event) => { if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') return; if (!synth || event.repeat || event.metaKey || event.ctrlKey || event.altKey ) return; const key = event.key.toLowerCase(); if (computerKeyNoteMapping[key] && !pressedComputerKeys.has(key)) { event.preventDefault(); const noteBase = computerKeyNoteMapping[key]; const fullNoteName = `${noteBase}${startingOctave}`; playNote(fullNoteName); pressedComputerKeys.add(key); } else if (key === 'z') { if (startingOctave > 0) { startingOctave--; dom.octaveDisplay.textContent = startingOctave; createOnScreenKeyboard(); } event.preventDefault(); } else if (key === 'x') { if (startingOctave < 8) { startingOctave++; dom.octaveDisplay.textContent = startingOctave; createOnScreenKeyboard(); } event.preventDefault(); } });
        window.addEventListener('keyup', (event) => { if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT') return; if (!synth) return; const key = event.key.toLowerCase(); if (computerKeyNoteMapping[key] && pressedComputerKeys.has(key)) { event.preventDefault(); const noteBase = computerKeyNoteMapping[key]; const fullNoteName = `${noteBase}${startingOctave}`; releaseNote(fullNoteName); pressedComputerKeys.delete(key); } });
        window.addEventListener('blur', releaseAllComputerKeys);
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') { releaseAllComputerKeys(); } });
        async function initializeMIDI() { /* ... (same) ... */ dom.midiStatus.textContent = "Accessing MIDI..."; if (navigator.requestMIDIAccess) { try { midiAccess = await navigator.requestMIDIAccess({ sysex: false }); dom.midiStatus.textContent = "MIDI Granted. Listening..."; populateMidiDevices(); startMIDIListening(); midiAccess.onstatechange = (event) => { dom.midiStatus.textContent = `MIDI: ${event.port.name} ${event.port.state}. Re-scan...`; populateMidiDevices(); startMIDIListening(); }; } catch (e) { let specificAdvice = ""; if (e.message && e.message.toLowerCase().includes("permission add-on")) { specificAdvice = " This error often appears in Firefox if MIDI permissions are not set or an add-on like Jazz-MIDI is needed and not configured. Please check your browser's site permissions for MIDI and ensure any required MIDI extensions are active."; } else if (e.name === "SecurityError") { specificAdvice = " MIDI access was denied by a security policy. This can happen if the page is not served over HTTPS, or if MIDI is disabled in browser settings/permissions."; } else { specificAdvice = " Please ensure your MIDI device is connected and check your browser's MIDI settings and site permissions."; } dom.midiStatus.textContent = `MIDI Access Error.${specificAdvice}`; console.error("Could not access MIDI devices:", e.name, e.message, specificAdvice); } } else { dom.midiStatus.textContent = "Web MIDI API not supported in this browser. Use Chrome/Edge for MIDI."; console.warn("Web MIDI API not supported in this browser!"); } }
        function populateMidiDevices() {
            if (!midiAccess) return;
            dom.midiInputSelect.innerHTML = ''; 
            if (midiAccess.inputs.size === 0) {
                const noDeviceOption = new Option("No MIDI devices found", "none");
                dom.midiInputSelect.add(noDeviceOption);
            } else {
                const allOption = new Option("Listen to All Devices", "all");
                dom.midiInputSelect.add(allOption);
                midiAccess.inputs.forEach(input => {
                    const option = new Option(input.name, input.id);
                    dom.midiInputSelect.add(option);
                });
            }
             dom.midiChannelSelect.innerHTML = '';
             const allChannelsOption = new Option("All Channels", "all");
             dom.midiChannelSelect.add(allChannelsOption);
             for(let i = 1; i <= 16; i++) {
                 const channelOption = new Option(`Channel ${i}`, i);
                 dom.midiChannelSelect.add(channelOption);
             }

        }
        function startMIDIListening() { 
            if (!midiAccess) return;
             midiAccess.inputs.forEach(input => { input.onmidimessage = null; });
            const selectedDeviceId = dom.midiInputSelect.value;
            if (selectedDeviceId === "all") {
                midiAccess.inputs.forEach(input => {
                    input.onmidimessage = onMIDIMessage;
                });
                dom.midiStatus.textContent = "Listening to all MIDI devices.";
            } else if (selectedDeviceId !== "none") {
                const selectedInput = midiAccess.inputs.get(selectedDeviceId);
                if (selectedInput) {
                    selectedInput.onmidimessage = onMIDIMessage;
                    dom.midiStatus.textContent = `Listening to: ${selectedInput.name}`;
                }
            }
        }
        function midiNoteToNoteNameAndOctave(midiNote) { const noteIndex = midiNote % 12; const octave = Math.floor(midiNote / 12) - 1; return `${noteNamesSharp[noteIndex]}${octave}`; }
        
        function onMIDIMessage(message) { 
            const [command, data1, data2] = message.data;
            const selectedChannel = dom.midiChannelSelect.value;
            const messageChannel = (command & 0x0f) + 1; 
            if (selectedChannel !== "all" && messageChannel != selectedChannel) {
                return; 
            }
            if (!synth) return;
            const type = command & 0xF0;
            if ((type === 0x90 && data2 > 0)) { const noteNameFull = midiNoteToNoteNameAndOctave(data1); const scaledVelocity = data2 / 127; playNote(noteNameFull, scaledVelocity); } else if (type === 0x80 || (type === 0x90 && data2 === 0)) { const noteNameFull = midiNoteToNoteNameAndOctave(data1); releaseNote(noteNameFull); } }
        

        // --- UI Control Event Listeners ---
        dom.startAudioButton.addEventListener('click', async (e) => { releaseAndRefocus(e); dom.audioContextMessageOverlay.classList.remove('visible'); const success = await initializeAudio(); if(success) console.log("Audio init OK from Start."); else console.error("Audio init FAILED from Start."); });
        dom.midiInputSelect.addEventListener('change', startMIDIListening);
        dom.midiChannelSelect.addEventListener('change', releaseAndRefocus);
        
        Object.keys(paramDefinitions).forEach(paramKey => { const definition = paramDefinitions[paramKey]; const element = dom[definition.elementId]; if (element) { element.addEventListener('change', releaseAndRefocus); if (definition.type === 'range') { element.addEventListener('mouseup', releaseAndRefocus); element.addEventListener('touchend', releaseAndRefocus, {passive: true});}} else { console.warn(`Element ID '${definition.elementId}' for param '${paramKey}' not found.`); }});

        dom.oscType.addEventListener('change', (e) => { updateOscillatorType(); releaseAndRefocus(e); });
        const oscParamHandler = () => { applyCurrentOscillatorSpecificSettings(dom.oscType.value); }; 
        dom.oscPhase.addEventListener('input', (e) => { updateSliderDisplay(dom.oscPhase, dom.oscPhaseDisplay, ' °', 0); oscParamHandler(); });
        dom.pulseWidth.addEventListener('input', (e) => { updateSliderDisplay(dom.pulseWidth, dom.pulseWidthDisplay, '', 2); oscParamHandler(); });
        dom.pwmSpeed.addEventListener('input', (e) => { updateSliderDisplay(dom.pwmSpeed, dom.pwmSpeedDisplay, 'Hz'); oscParamHandler(); });
        dom.fmHarmonicity.addEventListener('input', (e) => { updateSliderDisplay(dom.fmHarmonicity, dom.fmHarmonicityDisplay, '', 1); oscParamHandler();});
        dom.fmModIndex.addEventListener('input', (e) => { updateSliderDisplay(dom.fmModIndex, dom.fmModIndexDisplay, '', 0); oscParamHandler();});
        dom.supersawCount.addEventListener('input', (e) => { updateSliderDisplay(dom.supersawCount, dom.supersawCountDisplay, '', 0); oscParamHandler();});
        dom.supersawSpread.addEventListener('input', (e) => { updateSliderDisplay(dom.supersawSpread, dom.supersawSpreadDisplay, ' cents', 0); oscParamHandler();});
        dom.noiseType.addEventListener('change', (e) => {oscParamHandler(); releaseAndRefocus(e)});
        dom.resonantBodyHarmonicity.addEventListener('input', (e) => { updateSliderDisplay(dom.resonantBodyHarmonicity, dom.resonantBodyHarmonicityDisplay, '', 1); oscParamHandler(); });
        dom.resonantBodyModIndex.addEventListener('input', (e) => { updateSliderDisplay(dom.resonantBodyModIndex, dom.resonantBodyModIndexDisplay, '', 0); oscParamHandler(); });
        dom.formantVoiceHarmonicity.addEventListener('input', (e) => { updateSliderDisplay(dom.formantVoiceHarmonicity, dom.formantVoiceHarmonicityDisplay, '', 1); oscParamHandler(); });
        dom.formantVoiceModIndex.addEventListener('input', (e) => { updateSliderDisplay(dom.formantVoiceModIndex, dom.formantVoiceModIndexDisplay, '', 0); oscParamHandler(); });
        
        // Granular controls 
        dom.granularFileInput.addEventListener('change', (event) => { const file = event.target.files[0]; if (file && file.type === "audio/wav") { const reader = new FileReader(); reader.onload = (e_reader) => { Tone.Buffer.fromUrl(e_reader.target.result).then(buffer => { grainPlayerBuffer = buffer; if (dom.oscType.value === 'granular') { updateOscillatorType(); } dom.midiStatus.textContent = `Loaded: ${file.name.substring(0,20)}...`; }).catch(err => { console.error("Error loading WAV into Tone.Buffer:", err); dom.midiStatus.textContent = "Error loading WAV."; }); }; reader.readAsDataURL(file); } else if (file) { dom.midiStatus.textContent = "Please select a .wav file."; console.warn("GRANULAR: Non-WAV file selected."); } releaseAndRefocus(event); });
        const granularParamHandler = () => { if(synth && currentActiveSynthType === 'GrainPlayer' && synth.loaded) applyCurrentOscillatorSpecificSettings('granular');};
        dom.granularLoop.addEventListener('change', (e) => { granularParamHandler(); releaseAndRefocus(e); });
        dom.granularLoopStart.addEventListener('input', (e) => { updateSliderDisplay(dom.granularLoopStart, dom.granularLoopStartDisplay, '', 2); granularParamHandler(); });
        dom.granularLoopEnd.addEventListener('input', (e) => { updateSliderDisplay(dom.granularLoopEnd, dom.granularLoopEndDisplay, '', 2); granularParamHandler(); });
        dom.granularReverse.addEventListener('change', (e) => { granularParamHandler(); releaseAndRefocus(e); });
        dom.granularGrainSize.addEventListener('input', (e) => { updateSliderDisplay(dom.granularGrainSize, dom.granularGrainSizeDisplay, 's', 3); granularParamHandler(); });
        dom.granularOverlap.addEventListener('input', (e) => { updateSliderDisplay(dom.granularOverlap, dom.granularOverlapDisplay, 's', 3); granularParamHandler(); });
        dom.granularDetune.addEventListener('input', (e) => { updateSliderDisplay(dom.granularDetune, dom.granularDetuneDisplay, ' cents', 0); granularParamHandler(); });
        dom.granularPlaybackRate.addEventListener('input', (e) => { updateSliderDisplay(dom.granularPlaybackRate, dom.granularPlaybackRateDisplay, 'x', 2); granularParamHandler(); });

        // Octave buttons
        dom.octaveUpBtn.addEventListener('click', (e) => { if (startingOctave < 7) { startingOctave++; dom.octaveDisplay.textContent = startingOctave; createOnScreenKeyboard(); } releaseAndRefocus(e);}); 
        dom.octaveDownBtn.addEventListener('click', (e) => { if (startingOctave > 0) { startingOctave--; dom.octaveDisplay.textContent = startingOctave; createOnScreenKeyboard(); } releaseAndRefocus(e);});

        function updateVolumeAndEnvelopes() { applyCurrentOscillatorSpecificSettings(dom.oscType.value); } 
        dom.volume.addEventListener('input', (e) => { updateSliderDisplay(dom.volume, dom.volumeDisplay, 'dB',0); if(masterVCA) masterVCA.gain.value = Tone.dbToGain(parseFloat(e.target.value)); });
        dom.ampEnvAttack.addEventListener('input', (e) => { updateSliderDisplay(dom.ampEnvAttack, dom.ampEnvAttackDisplay, 's', 3); updateVolumeAndEnvelopes(); });
        dom.ampEnvDecay.addEventListener('input', (e) => { updateSliderDisplay(dom.ampEnvDecay, dom.ampEnvDecayDisplay, 's', 2); updateVolumeAndEnvelopes(); });
        dom.ampEnvSustain.addEventListener('input', (e) => { updateSliderDisplay(dom.ampEnvSustain, dom.ampEnvSustainDisplay, '', 2); updateVolumeAndEnvelopes(); });
        dom.ampEnvRelease.addEventListener('input', (e) => { updateSliderDisplay(dom.ampEnvRelease, dom.ampEnvReleaseDisplay, 's', 2); updateVolumeAndEnvelopes(); });

        const filterParamHandler = () => { applyCurrentOscillatorSpecificSettings(dom.oscType.value); };
        dom.filterType.addEventListener('change', (e) => {filterParamHandler(); releaseAndRefocus(e); }); 
        dom.filterEnvCurve.addEventListener('change', (e) => {filterParamHandler(); releaseAndRefocus(e);});
        dom.filterCutoff.addEventListener('input', (e) => { updateSliderDisplay(dom.filterCutoff, dom.filterCutoffDisplay, 'Hz', 0); filterParamHandler(); });
        dom.filterResonance.addEventListener('input', (e) => { updateSliderDisplay(dom.filterResonance, dom.filterResonanceDisplay, 'Q'); filterParamHandler(); });
        dom.filterEnvAttack.addEventListener('input', (e) => { updateSliderDisplay(dom.filterEnvAttack, dom.filterEnvAttackDisplay, 's', 3); filterParamHandler(); });
        dom.filterEnvDecay.addEventListener('input', (e) => { updateSliderDisplay(dom.filterEnvDecay, dom.filterEnvDecayDisplay, 's', 2); filterParamHandler(); });
        dom.filterEnvSustain.addEventListener('input', (e) => { updateSliderDisplay(dom.filterEnvSustain, dom.filterEnvSustainDisplay, '', 2); filterParamHandler(); });
        dom.filterEnvRelease.addEventListener('input', (e) => { updateSliderDisplay(dom.filterEnvRelease, dom.filterEnvReleaseDisplay, 's', 2); filterParamHandler(); });
        dom.filterEnvAmount.addEventListener('input', (e) => { updateSliderDisplay(dom.filterEnvAmount, dom.filterEnvAmountDisplay, ' oct', 1); filterParamHandler(); });

        const lfoUpdateHandler = () => { updateLFO1Connections(); updateLFO2Connections(); };
        dom.lfo1Enable.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);}); 
        dom.lfo1Retrigger.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);});
        dom.lfo1Wave.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);}); 
        dom.lfo1PulseWidth.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo1PulseWidth, dom.lfo1PulseWidthDisplay, '', 2); if (lfo1 && dom.lfo1Wave.value === 'pulse') lfo1.width.value = parseFloat(dom.lfo1PulseWidth.value); /* No blur from input for dragging */});
        dom.lfo1PwmFreq.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo1PwmFreq, dom.lfo1PwmFreqDisplay, 'Hz'); if (lfo1 && dom.lfo1Wave.value === 'pwm') lfo1.modulationFrequency.value = parseFloat(dom.lfo1PwmFreq.value); /* No blur from input for dragging */});
        dom.lfo1Rate.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo1Rate, dom.lfo1RateDisplay, 'Hz'); lfoUpdateHandler(); });
        dom.lfo1Depth.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo1Depth, dom.lfo1DepthDisplay, '', 2); lfoUpdateHandler(); });
        dom.lfo1Destination.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);});

        dom.lfo2Enable.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);}); 
        dom.lfo2Retrigger.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);});
        dom.lfo2Wave.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);}); 
        dom.lfo2PulseWidth.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo2PulseWidth, dom.lfo2PulseWidthDisplay, '', 2); if (lfo2 && dom.lfo2Wave.value === 'pulse') lfo2.width.value = parseFloat(dom.lfo2PulseWidth.value);});
        dom.lfo2PwmFreq.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo2PwmFreq, dom.lfo2PwmFreqDisplay, 'Hz'); if (lfo2 && dom.lfo2Wave.value === 'pwm') lfo2.modulationFrequency.value = parseFloat(dom.lfo2PwmFreq.value);});
        dom.lfo2Rate.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo2Rate, dom.lfo2RateDisplay, 'Hz'); lfoUpdateHandler(); });
        dom.lfo2Depth.addEventListener('input', (e) => { updateSliderDisplay(dom.lfo2Depth, dom.lfo2DepthDisplay, '', 2); lfoUpdateHandler(); });
        dom.lfo2Destination.addEventListener('change', (e) => {lfoUpdateHandler(); releaseAndRefocus(e);});


        // Effect Control Listeners
        const effectToggleHandler = (e) => { applyAudioChain(); releaseAndRefocus(e); };
        const effectWetHandler = (slider, display, unit, decimals, e) => { updateSliderDisplay(slider, display, unit, decimals); applyAudioChain(); /* No blur from input for dragging */ };
        const effectParamHandler = (slider, display, unit, decimals, effectNode, paramName, e) => { updateSliderDisplay(slider, display, unit, decimals); if(effectNode && effectNode[paramName] !== undefined) { if(typeof effectNode[paramName].value !== 'undefined') {effectNode[paramName].value = parseFloat(slider.value); } else {effectNode[paramName] = parseFloat(slider.value);} } /* No blur from input for dragging */ };
        
        dom.distEnable.addEventListener('change', effectToggleHandler); dom.distAmount.addEventListener('input', (e) => effectParamHandler(dom.distAmount, dom.distAmountDisplay, '', 2, distortionEffect, 'distortion', e)); dom.distWet.addEventListener('input', (e) => effectWetHandler(dom.distWet, dom.distWetDisplay, '', 2, e));
        dom.crusherEnable.addEventListener('change', effectToggleHandler); dom.crusherBits.addEventListener('input', (e) => { updateSliderDisplay(dom.crusherBits, dom.crusherBitsDisplay, ' bits', 0); if(bitCrusherEffect) bitCrusherEffect.bits.value = parseInt(dom.crusherBits.value); /* No blur */ }); dom.crusherWet.addEventListener('input', (e) => effectWetHandler(dom.crusherWet, dom.crusherWetDisplay, '', 2, e));
        dom.ringModEnable.addEventListener('change', (e) => {applyAudioChain(); releaseAndRefocus(e);});
        dom.ringModCarrierWave.addEventListener('change', (e) => {if(ringModulator) ringModulator.carrier.type = e.target.value; releaseAndRefocus(e);});
        dom.ringModFrequency.addEventListener('input', (e) => {updateSliderDisplay(dom.ringModFrequency, dom.ringModFrequencyDisplay, ' Hz', 0); if(ringModulator) ringModulator.frequency.value = parseFloat(e.target.value);});
        dom.ringModWet.addEventListener('input', (e) => {updateSliderDisplay(dom.ringModWet, dom.ringModWetDisplay, '', 2); if(ringModulator) ringModulator.wet.value = parseFloat(e.target.value);});
        dom.chorusEnable.addEventListener('change', effectToggleHandler); dom.chorusRate.addEventListener('input', (e) => effectParamHandler(dom.chorusRate, dom.chorusRateDisplay, 'Hz', 1, chorusEffect.frequency, 'value', e)); dom.chorusDepth.addEventListener('input', (e) => effectParamHandler(dom.chorusDepth, dom.chorusDepthDisplay, '', 2, chorusEffect, 'depth', e)); dom.chorusFeedback.addEventListener('input', (e) => effectParamHandler(dom.chorusFeedback, dom.chorusFeedbackDisplay, '', 2, chorusEffect.feedback, 'value', e)); dom.chorusWet.addEventListener('input', (e) => effectWetHandler(dom.chorusWet, dom.chorusWetDisplay, '', 2, e));
        dom.phaserEnable.addEventListener('change', effectToggleHandler); dom.phaserFrequency.addEventListener('input', (e) => effectParamHandler(dom.phaserFrequency, dom.phaserFrequencyDisplay, 'Hz', 1, phaserEffect.frequency, 'value', e)); dom.phaserOctaves.addEventListener('input', (e) => effectParamHandler(dom.phaserOctaves, dom.phaserOctavesDisplay, '', 1, phaserEffect, 'octaves', e)); dom.phaserBaseFreq.addEventListener('input', (e) => effectParamHandler(dom.phaserBaseFreq, dom.phaserBaseFreqDisplay, 'Hz', 0, phaserEffect, 'baseFrequency', e)); dom.phaserWet.addEventListener('input', (e) => effectWetHandler(dom.phaserWet, dom.phaserWetDisplay, '', 2, e));
        dom.delayEnable.addEventListener('change', effectToggleHandler); dom.delayTime.addEventListener('input', (e) => effectParamHandler(dom.delayTime, dom.delayTimeDisplay, 's', 2, delayEffect.delayTime, 'value', e)); dom.delayFeedback.addEventListener('input', (e) => effectParamHandler(dom.delayFeedback, dom.delayFeedbackDisplay, '', 2, delayEffect.feedback, 'value', e)); dom.delayWet.addEventListener('input', (e) => effectWetHandler(dom.delayWet, dom.delayWetDisplay, '', 2, e));
        dom.pingpongEnable.addEventListener('change', effectToggleHandler); dom.pingpongDelayTime.addEventListener('input', (e) => effectParamHandler(dom.pingpongDelayTime, dom.pingpongDelayTimeDisplay, 's', 2, pingPongDelayEffect.delayTime, 'value', e)); dom.pingpongFeedback.addEventListener('input', (e) => effectParamHandler(dom.pingpongFeedback, dom.pingpongFeedbackDisplay, '', 2, pingPongDelayEffect.feedback, 'value', e)); dom.pingpongWet.addEventListener('input', (e) => effectWetHandler(dom.pingpongWet, dom.pingpongWetDisplay, '', 2, e));
        dom.reverbEnable.addEventListener('change', effectToggleHandler); dom.reverbDecay.addEventListener('input', (e) => { updateSliderDisplay(dom.reverbDecay, dom.reverbDecayDisplay, 's'); if(reverbEffect) reverbEffect.decay = parseFloat(dom.reverbDecay.value); /* No blur */ }); dom.reverbWet.addEventListener('input', (e) => effectWetHandler(dom.reverbWet, dom.reverbWetDisplay, '', 2, e));
        
        // Sequencer Controls
        function initializeSequencer() {
            if (sequencer) {
                sequencer.dispose();
            }
            let seqNotes = generateRandomSequence();

            dom.sequencerRegen.addEventListener('click', (e) => {
                seqNotes = generateRandomSequence();
                if(sequencer) sequencer.events = seqNotes;
                releaseAndRefocus(e);
            });

            sequencer = new Tone.Sequence((time, note) => {
                if (!dom.sequencerEnable.checked) return;
                const gateProb = parseFloat(dom.sequencerGateProb.value) / 100;
                if (Math.random() > gateProb) return;

                const duration = parseFloat(dom.sequencerNoteDuration.value);
                playSequencerNote(note, duration, time);
            }, seqNotes, "8n").start(0);
            
            sequencer.loop = true;
            sequencer.playbackRate = parseFloat(dom.sequencerRate.value);

            function generateRandomSequence() {
                const notes = [];
                const scaleIntervals = scales[dom.sequencerScale.value] || scales.chromatic;
                const pitchSpread = parseInt(dom.sequencerPitchSpread.value);

                for (let i = 0; i < 8; i++) {
                    let randomNoteInScale = scaleIntervals[Math.floor(Math.random() * scaleIntervals.length)];
                    let baseMidiNote = (startingOctave * 12) + 24 + randomNoteInScale;
                    let randomOffset = Math.floor(Math.random() * (pitchSpread + 1)) - Math.floor(pitchSpread / 2);
                    let finalMidiNote = Math.round(baseMidiNote + randomOffset);
                    finalMidiNote = Math.max(0, Math.min(127, finalMidiNote));
                    notes.push(midiNoteToNoteNameAndOctave(finalMidiNote));
                }
                return notes;
            }
             
            dom.sequencerDirection.addEventListener('change', (e) => {
                sequencer.playbackRate = e.target.value === 'down' ? -1 * parseFloat(dom.sequencerRate.value) : parseFloat(dom.sequencerRate.value);
                sequencer.loop = e.target.value !== "upDown";
                sequencer.loopEnd = e.target.value === 'upDown' ? '1m' : '8n';
                releaseAndRefocus(e);
            });
            
            dom.sequencerSwing.addEventListener('input', (e) => {
                updateSliderDisplay(dom.sequencerSwing, dom.sequencerSwingDisplay, '', 2);
                Tone.Transport.swing = parseFloat(e.target.value);
            });
        }
        function playSequencerNote(note, duration, time) { /* ... (same) ... */ if (!synth || synth.disposed || Tone.context.state !== 'running') return; console.log(`SEQ: Playing ${note} for ${duration}s at ${time}`); try { if (synth instanceof Tone.PolySynth) { synth.triggerAttackRelease(note, duration, time); } else if(synth instanceof Tone.NoiseSynth) { synth.triggerAttackRelease(duration, time); } else if (synth instanceof Tone.GrainPlayer && synth.loaded) { applyCurrentOscillatorSpecificSettings('granular'); synth.start(time); } updateKeyVisualState(note, true); setTimeout(() => updateKeyVisualState(note, false), duration * 1000 * 0.9); } catch(e) { console.error("Error playing sequencer note:", e); }}
        

        dom.sequencerEnable.addEventListener('change', (e) => { if (e.target.checked) { if (Tone.Transport.state !== "started") { Tone.Transport.start(); } if(sequencer) sequencer.start(0); } else { if(sequencer) sequencer.stop(); } releaseAndRefocus(e); });
        dom.sequencerRate.addEventListener('input', (e) => { updateSliderDisplay(dom.sequencerRate, dom.sequencerRateDisplay, 'Hz', 1); if (sequencer) { sequencer.playbackRate = parseFloat(e.target.value); }});
        dom.sequencerGateProb.addEventListener('input', (e) => { updateSliderDisplay(dom.sequencerGateProb, dom.sequencerGateProbDisplay, '%', 0);  });
        dom.sequencerNoteDuration.addEventListener('input', (e) => { updateSliderDisplay(dom.sequencerNoteDuration, dom.sequencerNoteDurationDisplay, 's', 2);  });
        dom.sequencerPitchSpread.addEventListener('input', (e) => { updateSliderDisplay(dom.sequencerPitchSpread, dom.sequencerPitchSpreadDisplay, ' semi', 0);  });
        dom.sequencerScale.addEventListener('change', releaseAndRefocus);

        // --- Preset System ---
        const defaultSettings = { /* ... (all paramDefinitions keys with their default values) ... */
            oscType: "sine", oscPhase: 0, pulseWidth: 0.5, pwmSpeed: 5, fmHarmonicity: 1.5, fmModIndex: 10, supersawCount: 3, supersawSpread: 25, noiseType: "white", resonantBodyHarmonicity: 2.7, resonantBodyModIndex: 20, formantVoiceHarmonicity: 1.2, formantVoiceModIndex: 5,
            granularLoop: false, granularLoopStart: 0, granularLoopEnd: 1, granularReverse: false, granularGrainSize: 0.1, granularOverlap: 0.05, granularDetune: 0, granularPlaybackRate: 1,
            masterVolume: 0, ampEnvAttack: 0.01, ampEnvDecay: 0.1, ampEnvSustain: 0.4, ampEnvRelease: 0.8,
            filterType: "none", filterEnvCurve: "linear", filterCutoff: 15000, filterResonance: 1, filterEnvAttack: 0.05, filterEnvDecay: 0.2, filterEnvSustain: 0.5, filterEnvRelease: 1, filterEnvAmount: 3,
            lfo1Enable: false, lfo1Retrigger: false, lfo1Wave: "sine", lfo1PulseWidth: 0.5, lfo1PwmFreq: 2, lfo1Rate: 2, lfo1Depth: 0.5, lfo1Destination: "none",
            lfo2Enable: false, lfo2Retrigger: false, lfo2Wave: "sine", lfo2PulseWidth: 0.5, lfo2PwmFreq: 2, lfo2Rate: 5, lfo2Depth: 0.5, lfo2Destination: "none",
            distEnable: false, distAmount: 0, distWet: 0,
            crusherEnable: false, crusherBits: 8, crusherWet: 0,
            ringModEnable: false, ringModCarrierWave: 'sine', ringModFrequency: 100, ringModWet: 0,
            chorusEnable: false, chorusRate: 1.5, chorusDepth: 0.7, chorusFeedback: 0.2, chorusWet: 0,
            phaserEnable: false, phaserFrequency: 0.5, phaserOctaves: 3, phaserBaseFreq: 350, phaserWet: 0,
            delayEnable: false, delayTime: 0.25, delayFeedback: 0.3, delayWet: 0,
            pingpongEnable: false, pingpongDelayTime: 0.35, pingpongFeedback: 0.4, pingpongWet: 0,
            reverbEnable: false, reverbDecay: 1.5, reverbWet: 0,
            sequencerEnable: false, sequencerDirection: 'up', sequencerSwing: 0, sequencerRate: 2, sequencerGateProb: 50, sequencerNoteDuration: 0.1, sequencerPitchSpread: 7, sequencerScale: "chromatic"
        };
        const presets = {
            "Init": { ...defaultSettings },
            "Classic Saw Lead": { ...defaultSettings, oscType: "sawtooth", ampEnvAttack: 0.01, ampEnvDecay: 0.3, ampEnvSustain: 0.7, ampEnvRelease: 0.5, filterType: "moog", filterCutoff: 3500, filterResonance: 2, filterEnvAmount: 2.5 },
            "PWM Pad": { ...defaultSettings, oscType: "pwm", pwmSpeed: 0.5, ampEnvAttack: 0.8, ampEnvDecay: 1.5, ampEnvSustain: 0.6, ampEnvRelease: 2, chorusEnable: true, chorusWet: 0.4, reverbEnable: true, reverbDecay: 3, reverbWet: 0.3 },
            "FM Bell": { ...defaultSettings, oscType: "fmsine", fmHarmonicity: 3.5, fmModIndex: 15, ampEnvAttack: 0.005, ampEnvDecay: 1.0, ampEnvSustain: 0, ampEnvRelease: 1.2, reverbEnable: true, reverbDecay: 2, reverbWet: 0.25 },
            "Ambient Pad": { ...defaultSettings, oscType: "triangle", ampEnvAttack: 2.5, ampEnvDecay: 3, ampEnvSustain: 0.8, ampEnvRelease: 4, filterType: "ms20lp", filterCutoff: 1000, filterResonance: 1, filterEnvAmount: 1.5, lfo1Enable: true, lfo1Wave: "sine", lfo1Rate: 0.1, lfo1Depth: 0.2, lfo1Destination: "filterCutoff", reverbEnable: true, reverbDecay: 6, reverbWet: 0.5, delayEnable: true, delayTime: 0.7, delayFeedback: 0.6, delayWet: 0.25 },
            "Resonant Bass": { ...defaultSettings, oscType: "square", ampEnvAttack: 0.01, ampEnvDecay: 0.2, ampEnvSustain: 0.1, ampEnvRelease: 0.3, filterType: "moog", filterCutoff: 200, filterResonance: 8, filterEnvAmount: 4 },
            "303ish Acid": { ...defaultSettings, oscType: "sawtooth", ampEnvAttack: 0.01, ampEnvDecay: 0.6, ampEnvSustain: 0, ampEnvRelease: 0.3, filterType: "303lp", filterCutoff: 500, filterResonance: 15, filterEnvAttack: 0.01, filterEnvDecay: 0.4, filterEnvSustain: 0, filterEnvRelease: 0.2, filterEnvAmount: 5, distEnable:true, distAmount: 0.2, distWet: 0.3 },
            "Synth Bass": { ...defaultSettings, oscType: "square", ampEnvAttack: 0.01, ampEnvDecay: 0.25, ampEnvSustain: 0.5, ampEnvRelease: 0.2, filterType: "moog", filterCutoff: 800, filterResonance: 3, filterEnvAmount: 1.5 },
            "8-Bit Pluck": { ...defaultSettings, oscType: "square", ampEnvAttack: 0.005, ampEnvDecay: 0.1, ampEnvSustain: 0, ampEnvRelease: 0.1, bitCrusherEnable: true, crusherBits: 4, crusherWet: 0.5 },
            "Wobble Bass": { ...defaultSettings, oscType: "sawtooth", filterType: "moog", filterCutoff: 1200, filterResonance: 6, lfo1Enable: true, lfo1Wave: "sine", lfo1Rate: 8, lfo1Depth: 0.8, lfo1Destination: "filterCutoff", ampEnvAttack: 0.01, ampEnvDecay: 0.1, ampEnvSustain: 0.8, ampEnvRelease: 0.2 },
            "Spacey FX": { ...defaultSettings, filterType: "bandpass12", filterCutoff: 5000, filterResonance: 15, ampEnvAttack: 0.1, ampEnvSustain: 1, ampEnvRelease: 2, pingpongEnable: true, pingpongDelayTime: 0.2, pingpongFeedback: 0.7, pingpongWet: 0.8, lfo1Enable: true, lfo1Rate: 0.2, lfo1Depth: 1, lfo1Destination: "filterCutoff" },
            "Bright Brass": { ...defaultSettings, oscType: "supersaw", supersawCount: 5, supersawSpread: 40, ampEnvAttack: 0.1, ampEnvDecay: 0.5, ampEnvSustain: 0.8, ampEnvRelease: 0.4, chorusEnable: true, chorusWet: 0.3, filterType: "ms20lp", filterCutoff: 4000, filterResonance: 2 },
            "LFO S&H Noise": { ...defaultSettings, oscType: "noise", noiseType: "pink", filterType: "moog", filterCutoff: 2000, filterResonance: 5, filterEnvAmount: 0, ampEnvAttack: 0.01, ampEnvDecay: 0.1, ampEnvSustain: 1, lfo1Enable: true, lfo1Wave: "square", lfo1Rate: 8, lfo1Destination: "filterCutoff" },
            "Dual LFO Pulse": { ...defaultSettings, oscType: "pulse", pulseWidth: 0.5, ampEnvAttack: 0.2, ampEnvRelease: 0.8, lfo1Enable: true, lfo1Wave: "sine", lfo1Rate: 0.2, lfo1Depth: 0.5, lfo1Destination: "pulseWidth", lfo2Enable: true, lfo2Wave: "sawtooth", lfo2Rate: 3, lfo2Depth: 0.7, lfo2Destination: "filterCutoff", filterType: "moog", filterCutoff: 1500, filterResonance: 4, filterEnvAmount: 2 }
        };

        function populatePresetDropdown() {
            dom.presetSelect.innerHTML = ''; 
            const initOption = document.createElement('option');
            initOption.value = "Init";
            initOption.textContent = "Init";
            dom.presetSelect.appendChild(initOption);

            // Factory Presets
            const factoryGroup = document.createElement('optgroup');
            factoryGroup.label = "--- Factory Presets ---";
            for (const presetName in presets) {
                if (presetName !== "Init") { 
                    const option = document.createElement('option');
                    option.value = presetName;
                    option.textContent = presetName;
                    factoryGroup.appendChild(option);
                }
            }
            dom.presetSelect.appendChild(factoryGroup);

            // User Presets
            if (Object.keys(userPresets).length > 0) {
                const userGroup = document.createElement('optgroup');
                userGroup.label = "--- My Presets ---";
                for (const presetName in userPresets) {
                    const option = document.createElement('option');
                    option.value = presetName;
                    option.textContent = presetName;
                    userGroup.appendChild(option);
                }
                dom.presetSelect.appendChild(userGroup);
            }
        }

        function loadPreset(presetName) {
            console.log("Loading preset:", presetName);
            const settings = presets[presetName] || userPresets[presetName] || defaultSettings;
            
            if (dom.oscType.value !== settings.oscType) {
                dom.oscType.value = settings.oscType;
                updateOscillatorType(); 
            }

            for (const paramKey in settings) {
                const paramDef = paramDefinitions[paramKey];
                if (paramDef && dom[paramDef.elementId]) {
                    const element = dom[paramDef.elementId];
                    const value = settings[paramKey];

                    if (paramDef.type === 'range') {
                        element.value = value;
                        const displayEl = dom[paramDef.elementId + 'Display'];
                        if (displayEl) { 
                            const decimals = paramDefinitions[paramKey].decimals === 0 ? 0 : (paramDefinitions[paramKey].decimals || (Number.isInteger(value) ? 0 : 2));
                            updateSliderDisplay(element, displayEl, paramDefinitions[paramKey].unit || '', decimals);
                        }
                    } else if (paramDef.type === 'checkbox') {
                        element.checked = value;
                    } else if (paramDef.type === 'select') {
                        element.value = value;
                    }
                }
            }
            
            applyCurrentOscillatorSpecificSettings(dom.oscType.value);
            applyAudioChain();
            updateLFO1Connections();
            updateLFO2Connections(); 
            if (dom.oscType.value === 'granular' && (!grainPlayerBuffer || !grainPlayerBuffer.loaded)) {
                dom.midiStatus.textContent = "Preset loaded. Load WAV for Granular Osc.";
            } else {
                 dom.midiStatus.textContent = `${presetName} Loaded`;
            }
            setTimeout(() => { if (dom.midiStatus.textContent === `${presetName} Loaded` || dom.midiStatus.textContent === "Preset loaded. Load WAV for Granular Osc.") dom.midiStatus.textContent = ""; }, 2000);
        }

        dom.presetSelect.addEventListener('change', (e) => { 
            loadPreset(e.target.value); 
            releaseAndRefocus(e);
        });
        dom.savePresetButton.addEventListener('click', (e) => {
            const name = dom.presetNameInput.value.trim();
            if (name) {
                savePreset(name);
                dom.presetNameInput.value = '';
            } else {
                dom.midiStatus.textContent = "Please enter a name to save preset.";
                setTimeout(() => { dom.midiStatus.textContent = ""; }, 2000);
            }
             releaseAndRefocus(e);
        });

        function savePreset(name) {
            let currentSettings = {};
            for (const paramKey in paramDefinitions) {
                const element = dom[paramDefinitions[paramKey].elementId];
                if (element) {
                    currentSettings[paramKey] = (element.type === 'checkbox') ? element.checked : element.value;
                }
            }
            userPresets[name] = currentSettings;
            try {
                localStorage.setItem('syn7h_userPresets', JSON.stringify(userPresets));
                populatePresetDropdown(); // Refresh dropdown
                dom.presetSelect.value = name;
                dom.midiStatus.textContent = `Preset '${name}' saved!`;
            } catch (e) {
                dom.midiStatus.textContent = `Error saving preset.`;
                console.error("Error saving user presets:", e);
            }
        }

        function loadUserPresets() {
            try {
                const savedUserPresets = localStorage.getItem('syn7h_userPresets');
                if (savedUserPresets) {
                    userPresets = JSON.parse(savedUserPresets);
                    console.log("User presets loaded from localStorage.");
                }
            } catch (e) {
                console.error("Error loading user presets from localStorage:", e);
                userPresets = {};
            }
        }


        // --- Initial Page Load ---
        window.addEventListener('load', () => {
            document.body.tabIndex = -1; 
            console.log("Window loaded."); 
            dom.octaveDisplay.textContent = startingOctave; 
            createOnScreenKeyboard(); 
            loadUserPresets();
            populatePresetDropdown();
            
            loadPreset("Init"); 
            
            dom.pwmControls.classList.toggle('hidden', dom.oscType.value !== 'pwm'); 
            dom.fmControls.classList.toggle('hidden', dom.oscType.value !== 'fmsine');
            dom.supersawControls.classList.toggle('hidden', dom.oscType.value !== 'supersaw');
            dom.noiseControls.classList.toggle('hidden', dom.oscType.value !== 'noise');
            dom.pulseControls.classList.toggle('hidden', dom.oscType.value !== 'pulse');
            dom.resonantBodyControls.classList.toggle('hidden', dom.oscType.value !== 'resonantbody');
            dom.formantVoiceControls.classList.toggle('hidden', dom.oscType.value !== 'formantvoice');
            dom.granularControls.classList.toggle('hidden', dom.oscType.value !== 'granular');
            dom.lfo1PulseWidthControls.classList.toggle('hidden', dom.lfo1Wave.value !== 'pulse'); 
            dom.lfo1PwmFreqControls.classList.toggle('hidden', dom.lfo1Wave.value !== 'pwm'); 
            dom.lfo2PulseWidthControls.classList.toggle('hidden', dom.lfo2Wave.value !== 'pulse');
            dom.lfo2PwmFreqControls.classList.toggle('hidden', dom.lfo2Wave.value !== 'pwm');
            
            showMessage(dom.audioContextMessageOverlay, `Welcome to Syn7h_! Click "Start" to enable audio.
<br><br>
You can play notes with your mouse, a connected MIDI controller, or your computer's keyboard (QWERTY row for black keys, ASDF row for white keys).
<br><br>
<strong>Note:</strong> Computer keyboard playback can sometimes be buggy depending on your browser and OS.`, "Start", async () => {
                const success = await initializeAudio();
                if (!success) console.error("Initial audio setup FAILED after user interaction on load.");
                else console.log("Initial audio setup OK after user interaction on load.");
            });
        });
    </script>
</body>
</html>
